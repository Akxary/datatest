v.s_grnplm_as_t_didsd_016_db_stg.n0160000011000_acct_pymnt_opt.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011000_acct_pymnt_opt AS 
 SELECT src.sk_pymnt_option AS acct_pymnt_option_id,
    src.sk_agrmnt AS agrmnt_id,
    1::smallint AS pymnt_option_id,
    src.record_date_from AS acct_pymnt_option_start_dt,
    NULL::bigint AS pymnt_cat_id,
    src.pd_date AS acct_pymnt_due_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000019999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000019999_params
              WHERE b0160000019999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS acct_pymnt_option_end_dt,
    src.pd_amount::numeric(26,4) AS acct_pymnt_option_amt,
    NULL::date AS loan_availability_end_dt,
    NULL::integer AS acct_pymnt_nbr,
    NULL::date AS acct_pymnt_option_amt_start_dt,
    NULL::date AS acct_pymnt_option_amt_end_dt,
    NULL::integer AS acct_pymnt_option_amt_crncy_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011000_debt_fin_stat.sk_pymnt_option,
            c0160000011000_debt_fin_stat.sk_agrmnt,
            c0160000011000_debt_fin_stat.record_date_from,
            c0160000011000_debt_fin_stat.pd_date,
            c0160000011000_debt_fin_stat.record_date_to,
            c0160000011000_debt_fin_stat.pd_amount,
            c0160000011000_debt_fin_stat.info_system_id,
            c0160000011000_debt_fin_stat.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011000_debt_fin_stat
          WHERE 1 = 1 AND c0160000011000_debt_fin_stat.sk_agrmnt IS NOT NULL AND c0160000011000_debt_fin_stat.sk_pymnt_option IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011000_agmt_mtr_hst_w4.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011000_agmt_mtr_hst_w4 AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    src.acct_bal_summary_start_dt,
    src.acct_bal_summary_end_dt::date AS acct_bal_summary_end_dt,
    src.outstanding_amt::numeric(18,4) AS outstanding_amt,
    src.ovd_amt::numeric(18,4) AS ovd_amt,
    src.ovd_int_amt::numeric(18,4) AS ovd_int_amt,
    src.own_amt::numeric(18,4) AS own_amt,
    src.int_paid_amt::numeric(18,4) AS int_paid_amt,
    src.penalty_repaym::numeric(18,4) AS penalty_repaym,
    NULL::numeric(18,4) AS total_balance,
    NULL::numeric(18,4) AS credit_amt,
    src.loan_amt::numeric(18,4) AS loan_amt,
    src.loan_cash::numeric(18,4) AS loan_cash,
    src.loan_retail::numeric(18,4) AS loan_retail,
    src.ovl_amt::numeric(18,4) AS ovl_amt,
    src.ln_int_grc_amt::numeric(18,4) AS ln_int_grc_amt,
    src.ovd30_amt::numeric(18,4) AS ovd30_amt,
    src.ovd60_amt::numeric(18,4) AS ovd60_amt,
    src.ovd90_amt::numeric(18,4) AS ovd90_amt,
    src.ovd180_amt::numeric(18,4) AS ovd180_amt,
    src.ovd360_amt::numeric(18,4) AS ovd360_amt,
    src.ovlpd_amt::numeric(18,4) AS ovlpd_amt,
    src.ovd_paid_amt::numeric(18,4) AS ovd_paid_amt,
    src.all_credit_amt::numeric(18,4) AS all_credit_amt,
    src.ovd_int_paid_amt_bal::numeric(18,4) AS ovd_int_paid_amt_bal,
    src.ln_int_paid_amt::numeric(18,4) AS ln_int_paid_amt,
    src.ovd_int_paid_amt::numeric(18,4) AS ovd_int_paid_amt,
    src.ovd_int_amt_bal::numeric(18,4) AS ovd_int_amt_bal,
    src.ln_int_amt_bal_rub::numeric(23,5) AS ln_int_amt_bal_rub,
    src.ln_int_grc_amt_bal_rub::numeric(23,5) AS ln_int_grc_amt_bal_rub,
    src.trndate_45815_dt,
    src.trndate_49515_dt,
    src.fee_serv_number_rub::numeric(18,4) AS fee_serv_number_rub,
    src.bad_debts_ovd_rub::numeric(18,4) AS bad_debts_ovd_rub,
    src.bad_debts_ovd_int_rub::numeric(18,4) AS bad_debts_ovd_int_rub,
    src.bad_debts_fee_rub::numeric(18,4) AS bad_debts_fee_rub,
    src.bad_debts_penalty_rub::numeric(18,4) AS bad_debts_penalty_rub,
    src.bad_debts_nduty_rub::numeric(18,4) AS bad_debts_nduty_rub,
    src.penalty_repaym_day_rub::numeric(18,4) AS penalty_repaym_day_rub,
    src.ln_int_amount_rub::numeric(18,4) AS ln_int_amount_rub,
    src.ovl_int_amount_rub::numeric(18,4) AS ovl_int_amount_rub,
    src.ln_int_pd_cash_rub::numeric(18,4) AS ln_int_pd_cash_rub,
    src.ln_int_pd_retail_rub::numeric(18,4) AS ln_int_pd_retail_rub,
    src.crlim_close_dt,
    src.penalty_amount_rub::numeric(18,4) AS penalty_amount_rub,
    src.fee_pd_amount_rub::numeric(18,4) AS fee_pd_amount_rub,
    src.fee_amount_rub::numeric(18,4) AS fee_amount_rub,
    src.last_paym_dt,
    src.ovd_wo_amt_rub::numeric(18,4) AS ovd_wo_amt_rub,
    src.ovd_int_wo_amt_rub::numeric(18,4) AS ovd_int_wo_amt_rub,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id::smallint AS info_system_id
   FROM ( SELECT backbone.sk_agrmnt,
            backbone.record_date_from AS acct_bal_summary_start_dt,
            backbone.record_date_to AS acct_bal_summary_end_dt,
            COALESCE(c1000.loan_amount + c1000.pd_amount, _tgt.outstanding_amt) AS outstanding_amt,
            COALESCE(c1001.ovd_amount, _tgt.ovd_amt) AS ovd_amt,
            COALESCE(c1001.ovd_int_amount, _tgt.ovd_int_amt) AS ovd_int_amt,
            COALESCE(c1000.deposit_amount, _tgt.own_amt) AS own_amt,
            COALESCE(c1000.ln_int_paid_amount + c1001.ovd_int_paid_amount, _tgt.int_paid_amt) AS int_paid_amt,
            COALESCE(c1001.penalty_paid_amount, _tgt.penalty_repaym) AS penalty_repaym,
            COALESCE(c1000.loan_amount, _tgt.loan_amt) AS loan_amt,
            COALESCE(c1000.loan_cash, _tgt.loan_cash) AS loan_cash,
            COALESCE(c1000.loan_retail, _tgt.loan_retail) AS loan_retail,
            COALESCE(c1000.ovl_amount, _tgt.ovl_amt) AS ovl_amt,
            COALESCE(c1000.ln_int_grc_amnt, _tgt.ln_int_grc_amt) AS ln_int_grc_amt,
            COALESCE(c1001.ovd30_amount, _tgt.ovd30_amt) AS ovd30_amt,
            COALESCE(c1001.ovd60_amount, _tgt.ovd60_amt) AS ovd60_amt,
            COALESCE(c1001.ovd90_amount, _tgt.ovd90_amt) AS ovd90_amt,
            COALESCE(c1001.ovd180_amount, _tgt.ovd180_amt) AS ovd180_amt,
            COALESCE(c1001.ovd360_amount, _tgt.ovd360_amt) AS ovd360_amt,
            COALESCE(c1000.ovlpd_amount, _tgt.ovlpd_amt) AS ovlpd_amt,
            COALESCE(c1001.ovd_paid_amount, _tgt.ovd_paid_amt) AS ovd_paid_amt,
            COALESCE(c1000.all_credit_amount, _tgt.all_credit_amt) AS all_credit_amt,
            COALESCE(c1001.ovd_int_paid_amount_bal, _tgt.ovd_int_paid_amt_bal) AS ovd_int_paid_amt_bal,
            COALESCE(c1000.ln_int_paid_amount, _tgt.ln_int_paid_amt) AS ln_int_paid_amt,
            COALESCE(c1001.ovd_int_paid_amount, _tgt.ovd_int_paid_amt) AS ovd_int_paid_amt,
            COALESCE(c1001.ovd_int_amount_bal, _tgt.ovd_int_amt_bal) AS ovd_int_amt_bal,
            COALESCE(c1000.ln_int_amount_bal, _tgt.ln_int_amt_bal_rub) AS ln_int_amt_bal_rub,
            COALESCE(c1000.ln_int_grc_amnt_bal, _tgt.ln_int_grc_amt_bal_rub) AS ln_int_grc_amt_bal_rub,
            COALESCE(c1001.trndate_45815, _tgt.trndate_45815_dt) AS trndate_45815_dt,
            COALESCE(c1001.trndate_49515, _tgt.trndate_49515_dt) AS trndate_49515_dt,
            COALESCE(c1000.fee_amount_serv, _tgt.fee_serv_number_rub) AS fee_serv_number_rub,
            COALESCE(c1004.bad_debts_ovd, _tgt.bad_debts_ovd_rub) AS bad_debts_ovd_rub,
            COALESCE(c1004.bad_debts_ovd_int, _tgt.bad_debts_ovd_int_rub) AS bad_debts_ovd_int_rub,
            COALESCE(c1004.bad_debts_fee, _tgt.bad_debts_fee_rub) AS bad_debts_fee_rub,
            COALESCE(c1004.bad_debts_penalty, _tgt.bad_debts_penalty_rub) AS bad_debts_penalty_rub,
            COALESCE(c1004.bad_debts_nduty, _tgt.bad_debts_nduty_rub) AS bad_debts_nduty_rub,
            COALESCE(c1001.penalty_repaym, _tgt.penalty_repaym_day_rub) AS penalty_repaym_day_rub,
            COALESCE(c1000.ln_int_amount, _tgt.ln_int_amount_rub) AS ln_int_amount_rub,
            COALESCE(c1002.ovl_int_amount, _tgt.ovl_int_amount_rub) AS ovl_int_amount_rub,
            COALESCE(c1000.ln_int_pd_cash, _tgt.ln_int_pd_cash_rub) AS ln_int_pd_cash_rub,
            COALESCE(c1000.ln_int_pd_retail, _tgt.ln_int_pd_retail_rub) AS ln_int_pd_retail_rub,
            COALESCE(c1002.crlim_date_close, _tgt.crlim_close_dt) AS crlim_close_dt,
            COALESCE(c1001.penalty_amount, _tgt.penalty_amount_rub) AS penalty_amount_rub,
            COALESCE(c1000.fee_pd_amount, _tgt.fee_pd_amount_rub) AS fee_pd_amount_rub,
            COALESCE(c1000.fee_amount, _tgt.fee_amount_rub) AS fee_amount_rub,
            COALESCE(c1000.last_paym_date, _tgt.last_paym_dt) AS last_paym_dt,
            COALESCE(c1005.ovd_wo, _tgt.ovd_wo_amt_rub) AS ovd_wo_amt_rub,
            COALESCE(c1005.ovd_int_wo, _tgt.ovd_int_wo_amt_rub) AS ovd_int_wo_amt_rub,
                CASE
                    WHEN _tgt.agrmnt_id IS NULL THEN 'I'::text
                    ELSE 'X'::text
                END AS action_cd,
            backbone.input_file_id,
            backbone.info_system_id
           FROM ( SELECT uniq_data.sk_agrmnt,
                    uniq_data.record_date_from,
                    COALESCE((min(uniq_data.record_date_from) OVER (PARTITION BY uniq_data.sk_agrmnt ORDER BY uniq_data.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - '1 day'::interval day, '9999-12-31'::date::timestamp without time zone) AS record_date_to,
                    uniq_data.input_file_id,
                    uniq_data.info_system_id
                   FROM ( SELECT b_data.sk_agrmnt,
                            b_data.record_date_from,
                            max(b_data.input_file_id) AS input_file_id,
                            max(b_data.info_system_id) AS info_system_id
                           FROM ( SELECT c0160000011000_debt_fin_stat.sk_agrmnt,
                                    c0160000011000_debt_fin_stat.record_date_from,
                                    c0160000011000_debt_fin_stat.input_file_id,
                                    c0160000011000_debt_fin_stat.info_system_id
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011000_debt_fin_stat
                                UNION ALL
                                 SELECT c0160000011001_ovd_fin_stat.sk_agrmnt,
                                    c0160000011001_ovd_fin_stat.record_date_from,
                                    c0160000011001_ovd_fin_stat.input_file_id,
                                    c0160000011001_ovd_fin_stat.info_system_id
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011001_ovd_fin_stat
                                UNION ALL
                                 SELECT c0160000011002_attr.sk_agrmnt,
                                    c0160000011002_attr.record_date_from,
                                    c0160000011002_attr.input_file_id,
                                    c0160000011002_attr.info_system_id
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr
                                UNION ALL
                                 SELECT c0160000011004_res_wroff.sk_agrmnt,
                                    c0160000011004_res_wroff.record_date_from,
                                    c0160000011004_res_wroff.input_file_id,
                                    c0160000011004_res_wroff.info_system_id
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011004_res_wroff
                                UNION ALL
                                 SELECT c0160000011005_wo.sk_agrmnt,
                                    c0160000011005_wo.record_date_from,
                                    c0160000011005_wo.input_file_id,
                                    c0160000011005_wo.info_system_id
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011005_wo) b_data
                          GROUP BY b_data.sk_agrmnt, b_data.record_date_from) uniq_data) backbone
             LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000011000_debt_fin_stat c1000 ON 1 = 1 AND backbone.sk_agrmnt = c1000.sk_agrmnt AND backbone.record_date_from >= c1000.record_date_from AND backbone.record_date_from <= c1000.record_date_to
             LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000011001_ovd_fin_stat c1001 ON 1 = 1 AND backbone.sk_agrmnt = c1001.sk_agrmnt AND backbone.record_date_from >= c1001.record_date_from AND backbone.record_date_from <= c1001.record_date_to
             LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr c1002 ON 1 = 1 AND backbone.sk_agrmnt = c1002.sk_agrmnt AND backbone.record_date_from >= c1002.record_date_from AND backbone.record_date_from <= c1002.record_date_to
             LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000011004_res_wroff c1004 ON 1 = 1 AND backbone.sk_agrmnt = c1004.sk_agrmnt AND backbone.record_date_from >= c1004.record_date_from AND backbone.record_date_from <= c1004.record_date_to
             LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000011005_wo c1005 ON 1 = 1 AND backbone.sk_agrmnt = c1005.sk_agrmnt AND backbone.record_date_from >= c1005.record_date_from AND backbone.record_date_from <= c1005.record_date_to
             LEFT JOIN s_grnplm_as_t_didsd_016_db_dwh.""t_agrmnt_metric_hist$way4"" _tgt ON 1 = 1 AND backbone.sk_agrmnt = _tgt.agrmnt_id AND backbone.record_date_from >= _tgt.acct_bal_summary_start_dt AND backbone.record_date_from <= _tgt.acct_bal_summary_end_dt AND _tgt.deleted_flag = 'N'::text) src;

"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011002_acct_cred_limit.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011002_acct_cred_limit AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    4::smallint AS limit_type_id,
    src.record_date_from AS cred_limit_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000019999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000019999_params
              WHERE b0160000019999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS cred_limit_end_dt,
    COALESCE(( SELECT min(k_crncy_nk03.tgt_id) AS min
           FROM s_grnplm_as_t_didsd_016_db_tmd.k_crncy_nk03
          WHERE 1 = 1 AND k_crncy_nk03.nk03_w4_currency_cd = '810'::text AND k_crncy_nk03.info_system_inst_cd = '000001'::text AND k_crncy_nk03.info_system_type_cd = '016'::text), (-1)::bigint)::integer AS cred_limit_crncy_id,
    src.full_crlim::numeric(26,4) AS cred_limit_amt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011002_attr.sk_agrmnt,
            c0160000011002_attr.record_date_from,
            c0160000011002_attr.record_date_to,
            c0160000011002_attr.full_crlim,
            c0160000011002_attr.info_system_id,
            c0160000011002_attr.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr
          WHERE 1 = 1 AND c0160000011002_attr.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011002_acct_rate.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011002_acct_rate AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    1::smallint AS rate_type_id,
    2::smallint AS bal_cat_type_id,
    src.record_date_from AS acct_rate_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000019999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000019999_params
              WHERE b0160000019999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS acct_rate_end_dt,
    src.ln_int_rate::numeric(15,12) AS acct_rate,
    6::smallint AS acct_rate_time_period_id,
    (-1) AS intrst_calc_type_id,
    (-1) AS term_compliance_type_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011002_attr.sk_agrmnt,
            c0160000011002_attr.record_date_from,
            c0160000011002_attr.record_date_to,
            c0160000011002_attr.ln_int_rate,
            c0160000011002_attr.info_system_id,
            c0160000011002_attr.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr
          WHERE 1 = 1 AND c0160000011002_attr.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011002_agmt_cls_asc.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011002_agmt_cls_asc AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1028)::smallint AS agrmnt_clsfctn_id,
    src.record_date_from AS agrmnt_class_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000019999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000019999_params
              WHERE b0160000019999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_class_end_dt,
    src.sk_agrmnt_cls_val_early_ovd::smallint AS agrmnt_class_val_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011002_attr.sk_agrmnt,
            c0160000011002_attr.record_date_from,
            c0160000011002_attr.record_date_to,
            c0160000011002_attr.sk_agrmnt_cls_val_early_ovd,
            c0160000011002_attr.info_system_id,
            c0160000011002_attr.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr
          WHERE 1 = 1 AND c0160000011002_attr.sk_agrmnt IS NOT NULL) src
UNION ALL
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1029)::smallint AS agrmnt_clsfctn_id,
    src.record_date_from AS agrmnt_class_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000019999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000019999_params
              WHERE b0160000019999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_class_end_dt,
    src.sk_agrmnt_cls_val::smallint AS agrmnt_class_val_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011002_attr.sk_agrmnt,
            c0160000011002_attr.record_date_from,
            c0160000011002_attr.record_date_to,
            c0160000011002_attr.sk_agrmnt_cls_val,
            c0160000011002_attr.info_system_id,
            c0160000011002_attr.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr
          WHERE c0160000011002_attr.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011002_agmt_cls_val.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011002_agmt_cls_val AS 
 SELECT src.sk_agrmnt_cls_val_early_ovd AS agrmnt_class_val_id,
    (-1028)::smallint AS agrmnt_clsfctn_id,
    src.early_ovd::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011002_attr.sk_agrmnt_cls_val_early_ovd,
            c0160000011002_attr.early_ovd,
            c0160000011002_attr.info_system_id,
            min(c0160000011002_attr.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr
          WHERE c0160000011002_attr.sk_agrmnt_cls_val_early_ovd IS NOT NULL
          GROUP BY c0160000011002_attr.sk_agrmnt_cls_val_early_ovd, c0160000011002_attr.early_ovd, c0160000011002_attr.info_system_id) src
UNION ALL
 SELECT src.sk_agrmnt_cls_val AS agrmnt_class_val_id,
    (-1029)::smallint AS agrmnt_clsfctn_id,
    src.credit_attr::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011002_attr.sk_agrmnt_cls_val,
            c0160000011002_attr.credit_attr,
            c0160000011002_attr.info_system_id,
            min(c0160000011002_attr.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr
          WHERE c0160000011002_attr.sk_agrmnt_cls_val IS NOT NULL
          GROUP BY c0160000011002_attr.sk_agrmnt_cls_val, c0160000011002_attr.credit_attr, c0160000011002_attr.info_system_id) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011002_agrmnt.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011002_agrmnt AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
        CASE
            WHEN src._1002_contract_idt IS NULL THEN src.contract_expiration_dt
            ELSE src.acnt_date_expire
        END AS contract_expiration_dt,
        CASE
            CASE
                WHEN src._1003_contract_idt IS NULL THEN src.status_id
                ELSE src._1003_status_id
            END
            WHEN 51 THEN 10
            ELSE 9
        END AS acct_current_stts_type_id,
    src.crlim_date_open AS way4_f9_crlim_dt,
    'Y'::text::character(1) AS way4_f9_flag,
    src.agreement_open_date AS acct_open_dt,
    ( SELECT max(k_info_system.tgt_id) AS max
           FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
          WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000001'::text) AS acct_src_id,
    NULL::date AS acct_close_dt,
    NULL::date AS acct_signed_dt,
    src.agreement_number::character varying(255) AS agrmnt_num,
    COALESCE(src.contract_idt, src.agreement_id_w4::numeric)::bigint::character varying(255) AS host_agrmnt_cd,
    NULL::character varying(255) AS host_agrmnt_guid,
    1 AS agrmnt_categ_id,
    '1900-01-01'::date AS agrmnt_rec_start_dt,
    '9999-12-31'::date AS agrmnt_rec_end_dt,
    NULL::character(1) AS bki_grant_flag,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system AS info_system_id
   FROM ( SELECT COALESCE(_src.sk_agrmnt, c10.sk_agreement) AS sk_agrmnt,
            _src._1002_contract_idt,
            _src._1003_contract_idt,
            _src.contract_idt,
            _src.acnt_date_expire,
            _src.crlim_date_open,
            ( SELECT max(c0160000012007_status.status_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000012007_status
                  WHERE 1 = 1 AND c0160000012007_status.status_category = 'A'::text AND substr(c0160000012007_status.status_name, 1, 1) = _src.contr_status) AS _1003_status_id,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000001'::text) AS sk_info_system,
            c10.agreement_number,
            c10.agreement_id_w4,
            c10.agreement_open_date,
            c10.status_id,
            COALESCE(_src.acnt_date_expire, c10.date_expire) AS contract_expiration_dt,
            COALESCE(_src.input_file_id, c10.sk_input_file) AS sk_input_file
           FROM ( SELECT _sk_agrmnt.tgt_id AS sk_agrmnt,
                    COALESCE(c1002.contract_idt, c1003.contract_idt) AS contract_idt,
                    c1002.contract_idt AS _1002_contract_idt,
                    c1003.contract_idt AS _1003_contract_idt,
                    c1002.acnt_date_expire,
                    c1002.crlim_date_open,
                    c1003.contr_status,
                    COALESCE(c1002.input_file_id, c1003.input_file_id) AS input_file_id
                   FROM ( SELECT l016_1002_attr.contract_idt,
                            l016_1002_attr.record_date_to,
                            l016_1002_attr.record_date_from,
                            l016_1002_attr.acnt_date_expire,
                            l016_1002_attr.crlim_date_open,
                            l016_1002_attr.dl,
                            l016_1002_attr.input_file_id
                           FROM s_grnplm_as_t_didsd_016_db_stg.l016_1002_attr
                          WHERE 1 = 1 AND l016_1002_attr.record_date_to = '9999-12-31'::date) c1002
                     FULL JOIN ( SELECT l016_1003_ext_attr.contract_idt,
                            l016_1003_ext_attr.record_date_to,
                            l016_1003_ext_attr.record_date_from,
                            l016_1003_ext_attr.contr_status,
                            l016_1003_ext_attr.input_file_id
                           FROM s_grnplm_as_t_didsd_016_db_stg.l016_1003_ext_attr
                          WHERE 1 = 1 AND l016_1003_ext_attr.record_date_to = '9999-12-31'::date) c1003 ON c1003.contract_idt = c1002.contract_idt
                     LEFT JOIN ( SELECT k_agrmnt_nk07.tgt_id,
                            k_agrmnt_nk07.nk07_agreement_id_w4
                           FROM s_grnplm_as_t_didsd_016_db_tmd.k_agrmnt_nk07
                          WHERE k_agrmnt_nk07.info_system_inst_cd = '000001'::text AND k_agrmnt_nk07.info_system_type_cd = '016'::text AND k_agrmnt_nk07.nk07_agreement_id_w4 IS NOT NULL) _sk_agrmnt ON _sk_agrmnt.nk07_agreement_id_w4::numeric = COALESCE(c1002.contract_idt, c1003.contract_idt)) _src
             LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000012010_contract c10 ON 1 = 1 AND c10.agreement_id_w4::numeric = _src.contract_idt) src
  WHERE src.sk_agrmnt IS NOT NULL;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011002_agrmnt_to_coa.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011002_agrmnt_to_coa AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    COALESCE(src.sk_coa, (-1)::bigint) AS coa_id,
    src.record_date_from AS agrmnt_gl_acct_start_dt,
    (-1018)::bigint AS coa_to_agrmnt_role_id,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000019999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000019999_params
              WHERE b0160000019999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_gl_acct_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011002_attr.sk_agrmnt,
            c0160000011002_attr.sk_coa,
            c0160000011002_attr.record_date_from,
            c0160000011002_attr.record_date_to,
            c0160000011002_attr.info_system_id,
            c0160000011002_attr.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr
          WHERE 1 = 1 AND c0160000011002_attr.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011002_agr_text_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011002_agr_text_hist AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1006) AS agrmnt_text_type_id,
    src.record_date_from AS agrmnt_text_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000019999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000019999_params
              WHERE b0160000019999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_text_end_dt,
    src.etsm_id::character varying(4000) AS agrmnt_txt,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1002.sk_agrmnt,
            c1002.record_date_from,
            c1002.record_date_to,
            c1002.etsm_id,
            c1002.info_system_id,
            c1002.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000011007_contract_ids b1007
                  WHERE b1007.contract_idt = c1002.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr c1002) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011002_coa.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011002_coa AS 
 SELECT src.sk_coa AS coa_id,
    substr(src.loan_number, 1, 50)::character varying(50) AS coa_num,
    NULL::character varying(512) AS coa_name,
    src.acnt_date_open AS coa_start_dt,
    NULL::date AS coa_end_dt,
    NULL::character(3) AS summary_coa_ind,
    NULL::character varying(50) AS coa_src_id,
    NULL::integer AS crncy_id,
    NULL::bigint AS gl_main_acct_id,
    NULL::integer AS pl_rpt_cd_id,
    NULL::bigint AS gl_int_org_pty_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( WITH cte AS (
                 SELECT c0160000011002_attr.sk_coa,
                    c0160000011002_attr.loan_number,
                    c0160000011002_attr.acnt_date_open,
                    c0160000011002_attr.info_system_id,
                    c0160000011002_attr.input_file_id,
                    row_number() OVER (PARTITION BY c0160000011002_attr.sk_coa ORDER BY c0160000011002_attr.record_date_to DESC) AS qualify_1
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011002_attr
                  WHERE 1 = 1 AND c0160000011002_attr.sk_coa IS NOT NULL
                )
         SELECT cte.sk_coa,
            cte.loan_number,
            cte.acnt_date_open,
            cte.info_system_id,
            cte.input_file_id
           FROM cte
          WHERE cte.qualify_1 = 1) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011002_pty_access_dev.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011002_pty_access_dev AS 
 WITH cte_1 AS (
         SELECT _b.osb_id,
            _b.tb_number,
            _b.tb_old_number,
            _b.osb_number,
            _b.osb_name,
            _b.info_system_type_cd,
            _b.info_system_inst_cd,
            _b.input_file_name,
            _b.input_file_id,
            _b.info_system_id,
            _b.workflow_run_id,
            _b.current_load_flag,
            min(substr(_b.input_file_name, 12, 8)::date - 1) OVER (PARTITION BY _b.osb_id ORDER BY _b.input_file_name ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS actual_from_x,
            min(substr(_b.input_file_name, 12, 8)::date - 1) OVER (PARTITION BY _b.osb_id ORDER BY _b.input_file_name ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING) AS actual_to_x
           FROM s_grnplm_as_t_didsd_016_db_stg.s016_0001_branch _b
        ), cte_2 AS (
         SELECT _b.osb_id,
            _b.tb_number,
            _b.tb_old_number,
            _b.osb_number,
            _b.osb_name,
            _b.info_system_type_cd,
            _b.info_system_inst_cd,
            _b.input_file_name,
            _b.input_file_id,
            _b.info_system_id,
            _b.workflow_run_id,
            _b.current_load_flag,
            min(substr(_b.input_file_name, 12, 8)::date - 1) OVER (PARTITION BY _b.osb_id ORDER BY _b.input_file_name ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS actual_from_x,
            min(substr(_b.input_file_name, 12, 8)::date - 1) OVER (PARTITION BY _b.osb_id ORDER BY _b.input_file_name ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING) AS actual_to_x
           FROM s_grnplm_as_t_didsd_016_db_stg.s016_0001_branch _b
        ), cte_3 AS (
         SELECT b0160000011002_attr.contract_idt,
            b0160000011002_attr.dl,
            b0160000011002_attr.record_date_from,
            max(b0160000011002_attr.dl) OVER (PARTITION BY b0160000011002_attr.contract_idt ORDER BY b0160000011002_attr.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_dl,
            rank() OVER (PARTITION BY b0160000011002_attr.contract_idt ORDER BY b0160000011002_attr.record_date_from) AS rank_dl,
            b0160000011002_attr.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.b0160000011002_attr
        ), cte_4 AS (
         SELECT
                CASE
                    WHEN c1002.sk_party_vsp > 0 THEN c1002.sk_party_vsp
                    WHEN _s08.sk_party_vsp > 0 THEN _s08.sk_party_vsp
                    ELSE c10.sk_party_vsp
                END AS sk_pty_vsp,
            _s08.sk_access_device,
            c1002.contract_idt,
            c1002.record_date_from,
            c1002.input_file_id,
            row_number() OVER (PARTITION BY _s08.sk_access_device ORDER BY _s08.card_open_date_w4 DESC, _s08.last_modified_dt DESC) AS access_device_rank
           FROM ( SELECT _b1002.contract_idt,
                    _b1002.record_date_from,
                    COALESCE(_sk_pty_vsp.tgt_id, (-1)::bigint) AS sk_party_vsp,
                    _b1002.input_file_id
                   FROM ( SELECT b1002.contract_idt,
                            b1002.dl,
                            b1002.record_date_from,
                            b1002.prev_dl,
                            b1002.rank_dl,
                            b1002.input_file_id,
                            b1002.is_eq,
                            _b.tb_old_number,
                            _b.osb_number,
                            COALESCE(_b.tb_number || substr(b1002.dl, 3), b1002.dl) AS vsp_full_number
                           FROM ( SELECT cte_3.contract_idt,
                                    cte_3.dl,
                                    cte_3.record_date_from,
                                    cte_3.prev_dl,
                                    cte_3.rank_dl,
                                    cte_3.input_file_id,
CASE
 WHEN cte_3.dl = cte_3.prev_dl OR (cte_3.dl IS NULL AND cte_3.prev_dl IS NULL AND cte_3.rank_dl > 1) THEN 1
 ELSE 0
END AS is_eq
                                   FROM cte_3) b1002
                             LEFT JOIN ( SELECT _b_1.osb_id,
                                    _b_1.tb_number,
                                    _b_1.tb_old_number,
                                    _b_1.osb_number,
                                    _b_1.osb_name,
                                    _b_1.info_system_type_cd,
                                    _b_1.info_system_inst_cd,
                                    _b_1.input_file_name,
                                    _b_1.input_file_id,
                                    _b_1.info_system_id,
                                    _b_1.workflow_run_id,
                                    _b_1.current_load_flag,
                                    _b_1.actual_from_x,
                                    _b_1.actual_to_x,
CASE
 WHEN _b_1.actual_from_x IS NOT NULL THEN substr(_b_1.input_file_name, 12, 8)::date
 ELSE '1900-01-01'::date
END AS actual_from,
                                    COALESCE(_b_1.actual_to_x, '9999-12-31'::date) AS actual_to
                                   FROM cte_1 _b_1) _b ON 1 = 1 AND substr(b1002.dl, 1, 2) = _b.tb_old_number AND substr(b1002.dl, 3, 4) = _b.osb_number AND b1002.record_date_from >= _b.actual_from AND b1002.record_date_from <= _b.actual_to
                          WHERE 1 = 1 AND b1002.is_eq = 0) _b1002
                     LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.k_pty_nk13 _sk_pty_vsp ON 1 = 1 AND COALESCE(_sk_pty_vsp.nk13_vsp_full_number, ''::text) = _b1002.vsp_full_number AND _sk_pty_vsp.info_system_type_cd = '016'::text AND _sk_pty_vsp.info_system_inst_cd = '000001'::text) c1002
             LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000012010_contract c10 ON 1 = 1 AND c10.agreement_id_w4::numeric = c1002.contract_idt
             LEFT JOIN ( SELECT _s.last_modified_dt,
                    _s.card_open_date_w4,
                    COALESCE((min(_s.card_open_date_w4) OVER (PARTITION BY _s.contract_id_w4 ORDER BY _s.card_open_date_w4, _s.last_modified_dt, _s.card_id_w4 ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS card_ak255068_end_dt,
                    _s.contract_id_w4,
                    COALESCE(_sk_acc_dev.tgt_id,
                        CASE
                            WHEN _s.card_number IS NULL THEN (-1)
                            ELSE (-999)
                        END::bigint) AS sk_access_device,
                    COALESCE(_sk_pty_vsp.tgt_id,
                        CASE
                            WHEN _s.osb_tb_number IS NULL OR _s.osb_number IS NULL OR _s.card_vsp_number IS NULL THEN (-1)
                            ELSE (-999)
                        END::bigint) AS sk_party_vsp,
                    _s.input_file_id
                   FROM s_grnplm_as_t_didsd_016_db_stg.s016_0008_card _s
                     JOIN s_grnplm_as_t_didsd_016_db_tmd.k_access_device_nk10 _sk_acc_dev ON 1 = 1 AND _sk_acc_dev.nk10_card_number IS NOT NULL AND _sk_acc_dev.nk10_card_number = _s.card_number AND _sk_acc_dev.info_system_type_cd = '016'::text AND _sk_acc_dev.info_system_inst_cd = '000001'::text
                     LEFT JOIN ( SELECT _b_1.osb_id,
                            _b_1.tb_number,
                            _b_1.tb_old_number,
                            _b_1.osb_number,
                            _b_1.osb_name,
                            _b_1.info_system_type_cd,
                            _b_1.info_system_inst_cd,
                            _b_1.input_file_name,
                            _b_1.input_file_id,
                            _b_1.info_system_id,
                            _b_1.workflow_run_id,
                            _b_1.current_load_flag,
                            _b_1.actual_from_x,
                            _b_1.actual_to_x,
                                CASE
                                    WHEN _b_1.actual_from_x IS NOT NULL THEN substr(_b_1.input_file_name, 12, 8)::date
                                    ELSE '1900-01-01'::date
                                END AS actual_from,
                            COALESCE(_b_1.actual_to_x, '9999-12-31'::date) AS actual_to
                           FROM cte_2 _b_1) _b ON 1 = 1 AND _s.osb_tb_number = _b.tb_old_number AND _s.osb_number = _b.osb_number AND _b.info_system_type_cd = '016'::text AND _b.info_system_inst_cd = '000001'::text AND substr(_s.input_file_name, 12, 8)::date >= _b.actual_from AND substr(_s.input_file_name, 12, 8)::date <= _b.actual_to
                     LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.k_pty_nk13 _sk_pty_vsp ON 1 = 1 AND COALESCE(_sk_pty_vsp.nk13_vsp_full_number, ''::text) = btrim((COALESCE(_b.tb_number, ' '::text) || btrim(COALESCE(_b.osb_number, ' '::text))) || btrim(COALESCE(_s.card_vsp_number, ' '::text))) AND _sk_pty_vsp.info_system_type_cd = '016'::text AND _sk_pty_vsp.info_system_inst_cd = '000001'::text) _s08 ON 1 = 1 AND c1002.contract_idt = _s08.contract_id_w4::numeric AND c1002.record_date_from >= _s08.card_open_date_w4 AND c1002.record_date_from <= _s08.card_ak255068_end_dt
          WHERE 1 = 1 AND _s08.sk_access_device > 0
        )
 SELECT src.sk_pty_vsp AS pty_id,
    src.sk_access_device AS access_device_id,
    1::smallint AS pty_access_device_role_id,
    src.record_date_from AS pty_access_device_start_dt,
    src.record_date_to AS pty_access_device_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system AS info_system_id
   FROM ( SELECT _t.sk_pty_vsp,
            _t.sk_access_device,
            _t.record_date_from,
            _t.input_file_id AS sk_input_file,
            COALESCE((min(_t.record_date_from) OVER (PARTITION BY _t.sk_access_device ORDER BY _t.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS record_date_to,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000001'::text) AS sk_info_system,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000011007_contract_ids b1007
                  WHERE b1007.contract_idt = _t.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM ( SELECT cte_4.sk_pty_vsp,
                    cte_4.sk_access_device,
                    cte_4.contract_idt,
                    cte_4.record_date_from,
                    cte_4.input_file_id,
                    cte_4.access_device_rank
                   FROM cte_4
                  WHERE cte_4.sk_pty_vsp IS NOT NULL) _t
          WHERE 1 = 1 AND _t.access_device_rank = 1) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011003_acct_stts_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011003_acct_stts_hist AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
        CASE src.status_id
            WHEN 51 THEN 10
            ELSE 9
        END AS acct_stts_type_id,
    src.record_date_from AS acct_stts_start_dt,
    src.record_date_to AS acct_stts_end_dt,
    src.sk_acct_stts_reason_type AS acct_stts_reason_id,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT _src.sk_agrmnt,
            _src.record_date_from,
            COALESCE(_src.record_date_to, '9999-12-31'::date) AS record_date_to,
            COALESCE(_src.status_id, _c10.status_id) AS status_id,
            COALESCE(_src.sk_acct_stts_reason_type, _c10.sk_acct_stts_reason_type) AS sk_acct_stts_reason_type,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000001'::text) AS info_system_id,
            _src.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000011007_contract_ids b1007
                  WHERE b1007.contract_idt = _src.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM ( SELECT _sk_agrmnt.tgt_id AS sk_agrmnt,
                    _s1003.record_date_from,
                    COALESCE((min(_s1003.record_date_from) OVER (PARTITION BY _s1003.contract_idt ORDER BY _s1003.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS record_date_to,
                    s07.status_id,
                    _sk_acct_stts_reason_tp.tgt_id AS sk_acct_stts_reason_type,
                    _s1003.input_file_id,
                    _s1003.contract_idt
                   FROM ( SELECT _t.contract_idt,
                            _t.record_date_from,
                            _t.contr_status,
                            max(_t.contr_status) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_contr_status,
                                CASE
                                    WHEN _t.contr_status = (max(_t.contr_status) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) THEN 1
                                    ELSE 0
                                END AS is_eq,
                            _t.input_file_id
                           FROM ( SELECT s1003.contract_idt,
                                    s1003.record_date_from,
                                    s1003.contr_status,
                                    s1003.input_file_id
                                   FROM s_grnplm_as_t_didsd_016_db_stg.l016_1003_ext_attr s1003
                                  WHERE 1 = 1) _t) _s1003
                     LEFT JOIN ( SELECT k_agrmnt_nk07.tgt_id,
                            k_agrmnt_nk07.nk07_agreement_id_w4
                           FROM s_grnplm_as_t_didsd_016_db_tmd.k_agrmnt_nk07
                          WHERE k_agrmnt_nk07.info_system_inst_cd = '000001'::text AND k_agrmnt_nk07.info_system_type_cd = '016'::text AND k_agrmnt_nk07.nk07_agreement_id_w4 IS NOT NULL) _sk_agrmnt ON 1 = 1 AND _sk_agrmnt.nk07_agreement_id_w4::numeric = _s1003.contract_idt
                     LEFT JOIN ( SELECT c0160000010007_status.status_id,
                            substr(c0160000010007_status.status_name, 1, 1) AS status_cd
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000010007_status
                          WHERE 1 = 1 AND c0160000010007_status.status_category = 'A'::text) s07 ON 1 = 1 AND s07.status_cd = _s1003.contr_status
                     LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.k_acct_stts_reason_type_nk01 _sk_acct_stts_reason_tp ON 1 = 1 AND _sk_acct_stts_reason_tp.nk01_w4_status_id = s07.status_id AND _sk_acct_stts_reason_tp.nk01_w4_status_id IS NOT NULL AND _sk_acct_stts_reason_tp.info_system_type_cd = '016'::text AND _sk_acct_stts_reason_tp.info_system_inst_cd = '000001'::text
                  WHERE 1 = 1 AND _s1003.is_eq = 0 AND _sk_agrmnt.tgt_id IS NOT NULL) _src
             LEFT JOIN ( SELECT c10.sk_agreement,
                    c10.sk_acct_stts_reason_type,
                    c10.status_id,
                    c10.sk_input_file AS input_file_id,
                    c10.sk_info_system AS info_system_id,
                    c10.last_modified_dt,
                    c10.agreement_id_w4
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000010010_contract c10
                  WHERE 1 = 1 AND c10.sk_agreement > 0) _c10 ON 1 = 1 AND _c10.agreement_id_w4::numeric = _src.contract_idt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011004_acct_acct_grp.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011004_acct_acct_grp AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    COALESCE(src.sk_acct_grp, (-1)::bigint) AS acct_grp_id,
    src.record_date_from AS acct_assoc_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000019999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000019999_params
              WHERE b0160000019999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS acct_assoc_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011004_res_wroff.sk_agrmnt,
            c0160000011004_res_wroff.sk_acct_grp,
            c0160000011004_res_wroff.record_date_from,
            c0160000011004_res_wroff.record_date_to,
            c0160000011004_res_wroff.info_system_id,
            c0160000011004_res_wroff.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011004_res_wroff
          WHERE 1 = 1 AND c0160000011004_res_wroff.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011004_acct_grp.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011004_acct_grp AS 
 SELECT src.sk_acct_grp AS acct_grp_id,
    NULL::bigint AS prnt_acct_grp_id,
    src.portfolio_name::character varying(512) AS acct_grp_name,
    '1900-01-01'::date AS acct_grp_start_dt,
    '9999-12-31'::date AS acct_grp_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT _sk_acct_grp.tgt_id AS sk_acct_grp,
            _b.portfolio_name,
            _b.input_file_id,
            _b.info_system_id
           FROM ( SELECT b0160000011004_res_wroff.portfolio_name,
                    max(b0160000011004_res_wroff.info_system_id) AS info_system_id,
                    max(b0160000011004_res_wroff.input_file_id) AS input_file_id
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000011004_res_wroff
                  GROUP BY b0160000011004_res_wroff.portfolio_name) _b
             JOIN ( SELECT k_acct_grp_nk19.tgt_id,
                    k_acct_grp_nk19.nk19_w4_provision_code
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_acct_grp_nk19
                  WHERE k_acct_grp_nk19.info_system_inst_cd = '000001'::text AND k_acct_grp_nk19.info_system_type_cd = '016'::text AND k_acct_grp_nk19.nk19_w4_provision_code IS NOT NULL) _sk_acct_grp ON _sk_acct_grp.nk19_w4_provision_code = _b.portfolio_name
          WHERE 1 = 1 AND _sk_acct_grp.tgt_id IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011004_acct_rate.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011004_acct_rate AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    1::smallint AS rate_type_id,
    1::smallint AS bal_cat_type_id,
    src.record_date_from AS acct_rate_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000019999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000019999_params
              WHERE b0160000019999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS acct_rate_end_dt,
    src.reserv_loan_rate::numeric(15,12) AS acct_rate,
    6::smallint AS acct_rate_time_period_id,
    (-1) AS intrst_calc_type_id,
    (-1) AS term_compliance_type_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011004_res_wroff.sk_agrmnt,
            c0160000011004_res_wroff.record_date_from,
            c0160000011004_res_wroff.record_date_to,
            c0160000011004_res_wroff.reserv_loan_rate,
            c0160000011004_res_wroff.info_system_id,
            c0160000011004_res_wroff.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011004_res_wroff
          WHERE 1 = 1 AND c0160000011004_res_wroff.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011004_agmt_cls_asc.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011004_agmt_cls_asc AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    5::smallint AS agrmnt_clsfctn_id,
    src.record_date_from AS agrmnt_class_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000019999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000019999_params
              WHERE b0160000019999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_class_end_dt,
    COALESCE(src.sk_agrmnt_cls_val, (-1)::bigint) AS agrmnt_class_val_id,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1004.sk_agrmnt,
            c1004.record_date_from,
            c1004.record_date_to,
            c1004.sk_agrmnt_cls_val,
            c1004.info_system_id,
            c1004.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000011007_contract_ids b1007
                  WHERE b1007.contract_idt = c1004.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011004_res_wroff c1004
          WHERE 1 = 1 AND c1004.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011004_agmt_cls_val.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011004_agmt_cls_val AS 
 SELECT src.sk_agrmnt_cls_val AS agrmnt_class_val_id,
    5::smallint AS agrmnt_clsfctn_id,
    src.beh_type_category::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000011004_res_wroff.sk_agrmnt_cls_val,
            c0160000011004_res_wroff.beh_type_category,
            c0160000011004_res_wroff.info_system_id,
            min(c0160000011004_res_wroff.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011004_res_wroff
          WHERE 1 = 1 AND c0160000011004_res_wroff.sk_agrmnt_cls_val IS NOT NULL
          GROUP BY c0160000011004_res_wroff.sk_agrmnt_cls_val, c0160000011004_res_wroff.beh_type_category, c0160000011004_res_wroff.info_system_id) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011007_acct_acct_grp.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011007_acct_acct_grp AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000011007_contract_ids.sk_agrmnt,
            max(c0160000011007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000011007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011007_contract_ids
          WHERE c0160000011007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000011007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011007_acct_cred_limit.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011007_acct_cred_limit AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    src.limit_type_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c1007.sk_agrmnt,
            c1007.sk_info_system,
            c1007.sk_input_file,
            _limit_type.limit_type_id
           FROM ( SELECT c0160000011007_contract_ids.sk_agrmnt,
                    max(c0160000011007_contract_ids.info_system_id) AS sk_info_system,
                    max(c0160000011007_contract_ids.input_file_id) AS sk_input_file
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011007_contract_ids
                  WHERE c0160000011007_contract_ids.sk_agrmnt IS NOT NULL
                  GROUP BY c0160000011007_contract_ids.sk_agrmnt) c1007
             CROSS JOIN ( SELECT s.limit_type_id
                   FROM ( SELECT s1.limit_type_id
                           FROM ( SELECT 2::smallint AS limit_type_id) s1
                        UNION
                         SELECT s2.limit_type_id
                           FROM ( SELECT 4::smallint AS limit_type_id) s2) s) _limit_type) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011007_acct_pymnt_opt.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011007_acct_pymnt_opt AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    1::smallint AS pymnt_option_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000011007_contract_ids.sk_agrmnt,
            max(c0160000011007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000011007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011007_contract_ids
          WHERE c0160000011007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000011007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011007_acct_rate.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011007_acct_rate AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    1::smallint AS rate_type_id,
    src.bal_cat_type_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c1007.sk_agrmnt,
            c1007.sk_info_system,
            c1007.sk_input_file,
            _bal_cat_type.bal_cat_type_id
           FROM ( SELECT c0160000011007_contract_ids.sk_agrmnt,
                    max(c0160000011007_contract_ids.info_system_id) AS sk_info_system,
                    max(c0160000011007_contract_ids.input_file_id) AS sk_input_file
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011007_contract_ids
                  WHERE c0160000011007_contract_ids.sk_agrmnt IS NOT NULL
                  GROUP BY c0160000011007_contract_ids.sk_agrmnt) c1007
             CROSS JOIN ( SELECT s.bal_cat_type_id
                   FROM ( SELECT s1.bal_cat_type_id
                           FROM ( SELECT 1::smallint AS bal_cat_type_id) s1
                        UNION
                         SELECT s2.bal_cat_type_id
                           FROM ( SELECT 2::smallint AS bal_cat_type_id) s2) s) _bal_cat_type) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011007_acct_stts_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011007_acct_stts_hist AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000011007_contract_ids.sk_agrmnt,
            max(c0160000011007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000011007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011007_contract_ids
          WHERE c0160000011007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000011007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011007_agmt_cls_asc.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011007_agmt_cls_asc AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    src.agrmnt_clsfctn_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c07.sk_agrmnt,
            c07.sk_info_system,
            c07.sk_input_file,
            agrmnt_clsfctn.agrmnt_clsfctn_id
           FROM ( SELECT c0160000011007_contract_ids.sk_agrmnt,
                    max(c0160000011007_contract_ids.info_system_id) AS sk_info_system,
                    max(c0160000011007_contract_ids.input_file_id) AS sk_input_file
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011007_contract_ids
                  WHERE c0160000011007_contract_ids.sk_agrmnt IS NOT NULL
                  GROUP BY c0160000011007_contract_ids.sk_agrmnt) c07
             CROSS JOIN ( SELECT s.agrmnt_clsfctn_id
                   FROM ( SELECT s1.agrmnt_clsfctn_id
                           FROM ( SELECT (-1029)::smallint AS agrmnt_clsfctn_id) s1
                        UNION
                         SELECT s2.agrmnt_clsfctn_id
                           FROM ( SELECT (-1028)::smallint AS agrmnt_clsfctn_id) s2
                        UNION
                         SELECT s3.agrmnt_clsfctn_id
                           FROM ( SELECT 5::smallint AS agrmnt_clsfctn_id) s3) s) agrmnt_clsfctn) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011007_agmt_mtr_hst_w4.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011007_agmt_mtr_hst_w4 AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000011007_contract_ids.sk_agrmnt,
            max(c0160000011007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000011007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011007_contract_ids
          WHERE c0160000011007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000011007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011007_agrmnt_to_coa.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011007_agrmnt_to_coa AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1018)::bigint AS coa_to_agrmnt_role_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000011007_contract_ids.sk_agrmnt,
            max(c0160000011007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000011007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011007_contract_ids
          WHERE c0160000011007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000011007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011007_agr_text_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011007_agr_text_hist AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1006) AS agrmnt_text_type_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000011007_contract_ids.sk_agrmnt,
            (-1006) AS agrmnt_text_type_id,
            max(c0160000011007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000011007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000011007_contract_ids
          WHERE c0160000011007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000011007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011007_pty_access_dev.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011007_pty_access_dev AS 
 SELECT src.sk_access_device AS access_device_id,
    1::smallint AS pty_access_device_role_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( WITH cte AS (
                 SELECT c08.sk_access_device,
                    1 AS pty_access_device_role_id,
                    b1007.input_file_id,
                    b1007.info_system_id,
                    row_number() OVER (PARTITION BY c08.contract_id_w4 ORDER BY c08.card_open_date_w4 DESC, c08.last_modified_dt DESC) AS qualify_1
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000011007_contract_ids b1007
                     JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000010008_card c08 ON b1007.contract_idt = c08.contract_id_w4::numeric
                  WHERE 1 = 1 AND c08.sk_access_device > 0
                )
         SELECT cte.sk_access_device,
            cte.pty_access_device_role_id,
            cte.input_file_id,
            cte.info_system_id
           FROM cte
          WHERE cte.qualify_1 = 1) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000011008_agmt_class_val.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000011008_agmt_class_val AS 
 SELECT src.sk_agrmnt_class_val AS agrmnt_class_val_id,
    (-1042)::smallint AS agrmnt_clsfctn_id,
    src.class_val_cd::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
        CASE
            WHEN src.class_val_cd = '1'::text THEN '3 ЭТАП (КОРЗИНА)'::text
            ELSE src.class_val_cd
        END::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c1008.sk_agrmnt_class_val,
            c1008.stage_3_flag AS class_val_cd,
            min(c1008.input_file_id) AS sk_input_file,
            min(c1008.info_system_id) AS sk_info_system
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021008_rep_reserve c1008
          WHERE c1008.sk_agrmnt_class_val IS NOT NULL
          GROUP BY c1008.sk_agrmnt_class_val, c1008.stage_3_flag) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000012008_card_renew_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000012008_card_renew_hist AS 
 SELECT src.card_open_date_w4 AS access_device_renewal_dt,
    src.access_device_id,
        CASE
            WHEN src.card_expire IS NULL THEN NULL::timestamp without time zone
            WHEN length(src.card_expire) <> 4 THEN NULL::timestamp without time zone
            WHEN length(btrim(translate(src.card_expire, '1234567890'::text, ' '::text)::character varying(512)::text)) > 0 THEN NULL::timestamp without time zone
            ELSE (((((
            CASE
                WHEN substr(src.card_expire, 1, 2)::smallint < 90 THEN '20'::text
                ELSE '19'::text
            END || substr(src.card_expire, 1, 2)) || '-'::text) || substr(src.card_expire, 3, 2)) || '-01'::text)::date) + '1 mon'::interval month - '1 day'::interval day
        END::date AS access_device_expiration_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system AS info_system_id
   FROM ( SELECT c.card_open_date_w4,
            c.sk_access_device AS access_device_id,
            c.card_expire,
            c.sk_input_file,
            c.sk_info_system
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000012008_card c
             LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000012012_issue r ON r.card_id_w4 = c.card_id_w4 AND r.release_card_date = c.card_open_date_w4
             LEFT JOIN s_grnplm_as_t_didsd_016_db_dwh.t_card_renewal_hist h ON h.access_device_id = c.sk_access_device AND h.access_device_renewal_dt = c.card_open_date_w4
          WHERE r.card_id_w4 IS NULL AND h.access_device_id IS NULL AND c.card_open_date_w4 IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000012012_card_renewal_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000012012_card_renewal_hist AS 
 SELECT src.release_card_date AS access_device_renewal_dt,
    src.sk_access_device AS access_device_id,
    (((('20'::text || src.card_expire) || '01'::text)::date) + '1 mon'::interval month - '1 day'::interval day)::date AS aceess_device_expiration_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system AS info_system_id
   FROM ( WITH cte AS (
                 SELECT c12.release_card_date,
                    c08.sk_access_device,
                    c08.card_number,
                    c08.card_expire,
                    ( SELECT max(k_info_system.tgt_id) AS max
                           FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                          WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000001'::text) AS sk_info_system,
                    c12.input_file_id AS sk_input_file,
                    row_number() OVER (PARTITION BY c12.card_id_w4 ORDER BY c08.info_system_inst_cd DESC) AS qualify_1
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000012012_issue c12
                     JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000012008_card c08 ON c12.card_id_w4 = c08.card_id_w4
                )
         SELECT cte.release_card_date,
            cte.sk_access_device,
            cte.card_number,
            cte.card_expire,
            cte.sk_info_system,
            cte.sk_input_file
           FROM cte
          WHERE cte.qualify_1 = 1) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021000_acct_cred_limit.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021000_acct_cred_limit AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    2::smallint AS limit_type_id,
    src.record_date_from AS cred_limit_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS cred_limit_end_dt,
    COALESCE(( SELECT min(k_crncy_nk03.tgt_id) AS min
           FROM s_grnplm_as_t_didsd_016_db_tmd.k_crncy_nk03
          WHERE 1 = 1 AND k_crncy_nk03.nk03_w4_currency_cd = '810'::text AND k_crncy_nk03.info_system_inst_cd = '000001'::text AND k_crncy_nk03.info_system_type_cd = '016'::text), (-1)::bigint)::integer AS cred_limit_crncy_id,
    src.unused_crlim::numeric(26,4) AS cred_limit_amt,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1000.sk_agrmnt,
            c1000.record_date_from,
            c1000.record_date_to,
            c1000.unused_crlim,
            c1000.info_system_id,
            c1000.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1000.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021000_debt_fin_stat c1000
          WHERE 1 = 1 AND c1000.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021000_acct_pymnt_opt.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021000_acct_pymnt_opt AS 
 SELECT src.sk_pymnt_option AS acct_pymnt_option_id,
    src.sk_agrmnt AS agrmnt_id,
    1::smallint AS pymnt_option_id,
    src.record_date_from AS acct_pymnt_option_start_dt,
    NULL::bigint AS pymnt_cat_id,
    src.pd_date AS acct_pymnt_due_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS acct_pymnt_option_end_dt,
    src.pd_amount::numeric(26,4) AS acct_pymnt_option_amt,
    NULL::date AS loan_availability_end_dt,
    NULL::integer AS acct_pymnt_nbr,
    NULL::date AS acct_pymnt_option_amt_start_dt,
    NULL::date AS acct_pymnt_option_amt_end_dt,
    NULL::integer AS acct_pymnt_option_amt_crncy_id,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1000.sk_pymnt_option,
            c1000.sk_agrmnt,
            c1000.record_date_from,
            c1000.pd_date,
            c1000.record_date_to,
            c1000.pd_amount,
            c1000.info_system_id,
            c1000.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1000.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021000_debt_fin_stat c1000
          WHERE 1 = 1 AND c1000.sk_agrmnt IS NOT NULL AND c1000.sk_pymnt_option IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021000_agmt_mtr_hst_w4.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021000_agmt_mtr_hst_w4 AS 
 SELECT bb.sk_agrmnt AS agrmnt_id,
    bb.record_date_from AS acct_bal_summary_start_dt,
    bb.record_date_to AS acct_bal_summary_end_dt,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN
            CASE
                WHEN c0.loan_amount IS NOT NULL OR c0.pd_amount IS NOT NULL THEN COALESCE(c0.loan_amount, 0::numeric) + COALESCE(c0.pd_amount, 0::numeric)
                ELSE NULL::numeric
            END
            ELSE _tgt.outstanding_amt
        END AS outstanding_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd_amount
            ELSE _tgt.ovd_amt
        END AS ovd_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd_int_amount
            ELSE _tgt.ovd_int_amt
        END AS ovd_int_amt,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.deposit_amount
            ELSE _tgt.own_amt
        END AS own_amt,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.ln_int_paid_amount
            ELSE _tgt.ln_int_paid_amt
        END +
        CASE
            WHEN c1.ovd_int_paid_amount IS NOT NULL THEN c1.ovd_int_paid_amount
            ELSE _tgt.ovd_int_paid_amt
        END AS int_paid_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.penalty_paid_amount
            ELSE _tgt.penalty_repaym
        END AS penalty_repaym,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.loan_amount
            ELSE _tgt.loan_amt
        END AS loan_amt,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.loan_cash
            ELSE _tgt.loan_cash
        END AS loan_cash,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.loan_retail
            ELSE _tgt.loan_retail
        END AS loan_retail,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.ovl_amount
            ELSE _tgt.ovl_amt
        END AS ovl_amt,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.ln_int_grc_amnt
            ELSE _tgt.ln_int_grc_amt
        END AS ln_int_grc_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd30_amount
            ELSE _tgt.ovd30_amt
        END AS ovd30_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd60_amount
            ELSE _tgt.ovd60_amt
        END AS ovd60_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd90_amount
            ELSE _tgt.ovd90_amt
        END AS ovd90_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd180_amount
            ELSE _tgt.ovd180_amt
        END AS ovd180_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd360_amount
            ELSE _tgt.ovd360_amt
        END AS ovd360_amt,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.ovlpd_amount
            ELSE _tgt.ovlpd_amt
        END AS ovlpd_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd_paid_amount
            ELSE _tgt.ovd_paid_amt
        END AS ovd_paid_amt,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.all_credit_amount
            ELSE _tgt.all_credit_amt
        END AS all_credit_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd_int_paid_amount_bal
            ELSE _tgt.ovd_int_paid_amt_bal
        END AS ovd_int_paid_amt_bal,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.ln_int_paid_amount
            ELSE _tgt.ln_int_paid_amt
        END AS ln_int_paid_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd_int_paid_amount
            ELSE _tgt.ovd_int_paid_amt
        END AS ovd_int_paid_amt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.ovd_int_amount_bal
            ELSE _tgt.ovd_int_amt_bal
        END AS ovd_int_amt_bal,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.ln_int_amount_bal
            ELSE _tgt.ln_int_amt_bal_rub
        END AS ln_int_amt_bal_rub,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.ln_int_grc_amnt_bal
            ELSE _tgt.ln_int_grc_amt_bal_rub
        END AS ln_int_grc_amt_bal_rub,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.trndate_45815
            ELSE _tgt.trndate_45815_dt
        END AS trndate_45815_dt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.trndate_49515
            ELSE _tgt.trndate_49515_dt
        END AS trndate_49515_dt,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.fee_amount_serv
            ELSE _tgt.fee_serv_number_rub
        END AS fee_serv_number_rub,
        CASE
            WHEN c4.sk_agrmnt IS NOT NULL THEN c4.bad_debts_ovd
            ELSE _tgt.bad_debts_ovd_rub
        END AS bad_debts_ovd_rub,
        CASE
            WHEN c4.sk_agrmnt IS NOT NULL THEN c4.bad_debts_ovd_int
            ELSE _tgt.bad_debts_ovd_int_rub
        END AS bad_debts_ovd_int_rub,
        CASE
            WHEN c4.sk_agrmnt IS NOT NULL THEN c4.bad_debts_fee
            ELSE _tgt.bad_debts_fee_rub
        END AS bad_debts_fee_rub,
        CASE
            WHEN c4.sk_agrmnt IS NOT NULL THEN c4.bad_debts_penalty
            ELSE _tgt.bad_debts_penalty_rub
        END AS bad_debts_penalty_rub,
        CASE
            WHEN c4.sk_agrmnt IS NOT NULL THEN c4.bad_debts_nduty
            ELSE _tgt.bad_debts_nduty_rub
        END AS bad_debts_nduty_rub,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.penalty_repaym
            ELSE _tgt.penalty_repaym_day_rub
        END AS penalty_repaym_day_rub,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.ln_int_amount
            ELSE _tgt.ln_int_amount_rub
        END AS ln_int_amount_rub,
        CASE
            WHEN c2.sk_agrmnt IS NOT NULL THEN c2.ovl_int_amount
            ELSE _tgt.ovl_int_amount_rub
        END AS ovl_int_amount_rub,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.ln_int_pd_cash
            ELSE _tgt.ln_int_pd_cash_rub
        END AS ln_int_pd_cash_rub,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.ln_int_pd_retail
            ELSE _tgt.ln_int_pd_retail_rub
        END AS ln_int_pd_retail_rub,
        CASE
            WHEN c2.sk_agrmnt IS NOT NULL THEN c2.crlim_date_close
            ELSE _tgt.crlim_close_dt
        END AS crlim_close_dt,
        CASE
            WHEN c1.sk_agrmnt IS NOT NULL THEN c1.penalty_amount
            ELSE _tgt.penalty_amount_rub
        END AS penalty_amount_rub,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.fee_pd_amount
            ELSE _tgt.fee_pd_amount_rub
        END AS fee_pd_amount_rub,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.fee_amount
            ELSE _tgt.fee_amount_rub
        END AS fee_amount_rub,
        CASE
            WHEN c0.sk_agrmnt IS NOT NULL THEN c0.last_paym_date
            ELSE _tgt.last_paym_dt
        END AS last_paym_dt,
        CASE
            WHEN c5.sk_agrmnt IS NOT NULL THEN c5.ovd_wo
            ELSE _tgt.ovd_wo_amt_rub
        END AS ovd_wo_amt_rub,
        CASE
            WHEN c5.sk_agrmnt IS NOT NULL THEN c5.ovd_int_wo
            ELSE _tgt.ovd_int_wo_amt_rub
        END AS ovd_int_wo_amt_rub,
        CASE
            WHEN c8.sk_agrmnt IS NOT NULL THEN c8.prov_ifrs9_ras
            ELSE _tgt.way4_estimated_res_bal_rub
        END AS way4_estimated_res_bal_rub,
        CASE
            WHEN c8.sk_agrmnt IS NOT NULL THEN c8.gross_carrying_amount_on_b
            ELSE _tgt.way4_gross_carrying_rub
        END AS way4_gross_carrying_rub,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    COALESCE(c0.input_file_id, c1.input_file_id, c2.input_file_id, c4.input_file_id, c5.input_file_id, _tgt.input_file_id) AS input_file_id,
    ( SELECT max(k_info_system.tgt_id) AS max
           FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
          WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000002'::text) AS info_system_id
   FROM ( SELECT _t3.sk_agrmnt,
            _t3.record_date_from,
            COALESCE((min(_t3.record_date_from) OVER (PARTITION BY _t3.sk_agrmnt ORDER BY _t3.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - '1 day'::interval day, '9999-12-31'::date::timestamp without time zone) AS record_date_to
           FROM ( SELECT uniq_data.sk_agrmnt,
                        CASE
                            WHEN uniq_data.record_date_from < df.date_from THEN df.date_from
                            ELSE uniq_data.record_date_from
                        END AS record_date_from
                   FROM ( SELECT c0160000021000_debt_fin_stat.sk_agrmnt,
                            c0160000021000_debt_fin_stat.record_date_from,
                            c0160000021000_debt_fin_stat.record_date_to
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021000_debt_fin_stat
                        UNION
                         SELECT c0160000021001_ovd_fin_stat.sk_agrmnt,
                            c0160000021001_ovd_fin_stat.record_date_from,
                            c0160000021001_ovd_fin_stat.record_date_to
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021001_ovd_fin_stat
                        UNION
                         SELECT c0160000021002_attr.sk_agrmnt,
                            c0160000021002_attr.record_date_from,
                            c0160000021002_attr.record_date_to
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr
                        UNION
                         SELECT c0160000021004_res_wroff.sk_agrmnt,
                            c0160000021004_res_wroff.record_date_from,
                            c0160000021004_res_wroff.record_date_to
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021004_res_wroff
                        UNION
                         SELECT c0160000021005_wo.sk_agrmnt,
                            c0160000021005_wo.record_date_from,
                            c0160000021005_wo.record_date_to
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021005_wo
                        UNION
                         SELECT c0160000021005_wo.sk_agrmnt,
                            c0160000021005_wo.record_date_from + 1,
                            c0160000021005_wo.record_date_to
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021005_wo
                        UNION
                         SELECT c0160000021008_rep_reserve.sk_agrmnt,
                            c0160000021008_rep_reserve.banking_date,
                            '9999-12-31'::date AS date
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021008_rep_reserve
                          GROUP BY c0160000021008_rep_reserve.sk_agrmnt, c0160000021008_rep_reserve.banking_date, '9999-12-31'::date) uniq_data
                     CROSS JOIN ( SELECT max(b0160000029999_params.paramvalue::date) AS date_from
                           FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
                          WHERE 1 = 1 AND b0160000029999_params.paramname = 'DATE_FROM'::text) df
                  WHERE 1 = 1 AND uniq_data.record_date_to >= df.date_from
                  GROUP BY uniq_data.sk_agrmnt,
                        CASE
                            WHEN uniq_data.record_date_from < df.date_from THEN df.date_from
                            ELSE uniq_data.record_date_from
                        END
                UNION
                 SELECT _w.agrmnt_id,
                    _w.acct_bal_summary_start_dt
                   FROM s_grnplm_as_t_didsd_016_db_stg.""t_agrmnt_metric_hist$way4"" _w
                  WHERE 1 = 1 AND _w.deleted_flag = 'N'::text AND _w.acct_bal_summary_start_dt > (( SELECT max(b0160000029999_params.paramvalue::date) AS max
                           FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
                          WHERE 1 = 1 AND b0160000029999_params.paramname = 'DATE_FROM'::text)) AND (EXISTS ( SELECT 1
                           FROM ( SELECT c0160000021000_debt_fin_stat.sk_agrmnt
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021000_debt_fin_stat
                                UNION
                                 SELECT c0160000021001_ovd_fin_stat.sk_agrmnt
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021001_ovd_fin_stat
                                UNION
                                 SELECT c0160000021002_attr.sk_agrmnt
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr
                                UNION
                                 SELECT c0160000021004_res_wroff.sk_agrmnt
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021004_res_wroff
                                UNION
                                 SELECT c0160000021005_wo.sk_agrmnt
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021005_wo
                                UNION
                                 SELECT c0160000021008_rep_reserve.sk_agrmnt
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021008_rep_reserve
                                  GROUP BY c0160000021008_rep_reserve.sk_agrmnt) _t1
                             LEFT JOIN ( SELECT c0160000021007_contract_ids.sk_agrmnt
                                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021007_contract_ids
                                  GROUP BY c0160000021007_contract_ids.sk_agrmnt) ctr_ids ON _t1.sk_agrmnt = ctr_ids.sk_agrmnt
                          WHERE 1 = 1 AND ctr_ids.sk_agrmnt IS NULL AND _t1.sk_agrmnt = _w.agrmnt_id))) _t3) bb
     LEFT JOIN ( SELECT t.contract_idt,
            t.record_date_to,
            t.unused_crlim,
            t.deposit_amount,
            t.loan_amount,
            t.pd_amount,
            t.loan_cash,
            t.loan_retail,
            t.ln_int_pd_cash,
            t.ln_int_pd_retail,
            t.ovlpd_amount,
            t.ovl_amount,
            t.ln_int_amount,
            t.all_credit_amount,
            t.fee_pd_amount,
            t.fee_amount,
            t.pd_date,
            t.last_paym_date,
            t.ln_int_paid_amount,
            t.ln_int_grc_amnt,
            t.ln_int_grc_amnt_bal,
            t.ln_int_amount_bal,
            t.fee_amount_serv,
            t.record_date_from,
            t.input_file_id,
            t.info_system_id,
            t.sk_agrmnt,
            t.sk_pymnt_option,
            COALESCE((min(t.record_date_from) OVER (PARTITION BY t.sk_agrmnt ORDER BY t.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - '1 day'::interval day, '9999-12-31'::date::timestamp without time zone) AS tech_date_to
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021000_debt_fin_stat t) c0 ON 1 = 1 AND bb.sk_agrmnt = c0.sk_agrmnt AND bb.record_date_from >= c0.record_date_from AND bb.record_date_from <= c0.tech_date_to
     LEFT JOIN ( SELECT t.contract_idt,
            t.record_date_to,
            t.ovd_amount,
            t.ovd30_amount,
            t.ovd60_amount,
            t.ovd90_amount,
            t.ovd180_amount,
            t.ovd_int_amount,
            t.penalty_amount,
            t.ovd_paid_amount,
            t.ovd_int_paid_amount,
            t.penalty_paid_amount,
            t.trndate_45815,
            t.ovd_int_paid_amount_bal,
            t.ovd_int_amount_bal,
            t.trndate_49515,
            t.penalty_repaym,
            t.ovd360_amount,
            t.record_date_from,
            t.input_file_id,
            t.info_system_id,
            t.sk_agrmnt,
            COALESCE((min(t.record_date_from) OVER (PARTITION BY t.sk_agrmnt ORDER BY t.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - '1 day'::interval day, '9999-12-31'::date::timestamp without time zone) AS tech_date_to
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021001_ovd_fin_stat t) c1 ON 1 = 1 AND bb.sk_agrmnt = c1.sk_agrmnt AND bb.record_date_from >= c1.record_date_from AND bb.record_date_from <= c1.tech_date_to
     LEFT JOIN ( SELECT t.contract_idt,
            t.record_date_to,
            t.loan_number,
            t.acnt_date_open,
            t.crlim_date_open,
            t.crlim_date_close,
            t.acnt_date_expire,
            t.etsm_id,
            t.cb_code,
            t.full_crlim,
            t.ovl_int_amount,
            t.ln_int_rate,
            t.credit_attr,
            t.dl,
            t.early_ovd,
            t.record_date_from,
            t.input_file_id,
            t.info_system_id,
            t.sk_agrmnt,
            t.sk_coa,
            t.sk_agrmnt_cls_val_early_ovd,
            t.sk_agrmnt_cls_val,
            COALESCE((min(t.record_date_from) OVER (PARTITION BY t.sk_agrmnt ORDER BY t.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - '1 day'::interval day, '9999-12-31'::date::timestamp without time zone) AS tech_date_to
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr t) c2 ON 1 = 1 AND bb.sk_agrmnt = c2.sk_agrmnt AND bb.record_date_from >= c2.record_date_from AND bb.record_date_from <= c2.tech_date_to
     LEFT JOIN ( SELECT t.contract_idt,
            t.record_date_to,
            t.portfolio_name,
            t.beh_type_category,
            t.reserv_loan_rate,
            t.bad_debts_ovd,
            t.bad_debts_ovd_int,
            t.bad_debts_fee,
            t.bad_debts_penalty,
            t.bad_debts_nduty,
            t.record_date_from,
            t.input_file_id,
            t.info_system_id,
            t.sk_agrmnt,
            t.sk_acct_grp,
            t.sk_agrmnt_cls_val,
            COALESCE((min(t.record_date_from) OVER (PARTITION BY t.sk_agrmnt ORDER BY t.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - '1 day'::interval day, '9999-12-31'::date::timestamp without time zone) AS tech_date_to
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021004_res_wroff t) c4 ON 1 = 1 AND bb.sk_agrmnt = c4.sk_agrmnt AND bb.record_date_from >= c4.record_date_from AND bb.record_date_from <= c4.tech_date_to
     LEFT JOIN ( SELECT t.input_file_name,
            t.info_system_type_cd,
            t.info_system_inst_cd,
            t.input_file_id,
            t.info_system_id,
            t.banking_date,
            t.contract_number,
            t.record_source,
            t.gross_carrying_amount_on_b,
            t.av_rate_on_b,
            t.prov_ifrs9_ras,
            t.stage_3_flag,
            t.acnt_contract_id,
            t.calc_rate_off_b,
            t.sk_agrmnt,
            t.sk_agrmnt_class_val,
            COALESCE((min(t.banking_date) OVER (PARTITION BY t.sk_agrmnt ORDER BY t.banking_date ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - '1 day'::interval day, '9999-12-31'::date::timestamp without time zone) AS tech_date_to
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021008_rep_reserve t) c8 ON 1 = 1 AND bb.sk_agrmnt = c8.sk_agrmnt AND bb.record_date_from >= c8.banking_date AND bb.record_date_from <= c8.tech_date_to
     LEFT JOIN ( SELECT _t.contract_idt,
            _t.ovd_wo,
            _t.ovd_int_wo,
            _t.record_date_from,
            _t.input_file_id,
            _t.info_system_id,
            _t.sk_agrmnt,
            COALESCE((-1) + (max(_t.record_date_from) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)), '9999-12-31'::date) AS record_date_to
           FROM ( SELECT c0160000021005_wo.contract_idt,
                    c0160000021005_wo.ovd_wo,
                    c0160000021005_wo.ovd_int_wo,
                    c0160000021005_wo.record_date_from,
                    c0160000021005_wo.input_file_id,
                    c0160000021005_wo.info_system_id,
                    c0160000021005_wo.sk_agrmnt
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021005_wo
                  WHERE 1 = 1 AND NOT (COALESCE(c0160000021005_wo.ovd_wo, 0::numeric) = 0::numeric AND COALESCE(c0160000021005_wo.ovd_int_wo, 0::numeric) = 0::numeric)
                UNION ALL
                 SELECT c0160000021005_wo.contract_idt,
                    0 AS ovd_wo,
                    0 AS ovd_int_wo,
                    c0160000021005_wo.record_date_from + 1 AS record_date_from,
                    c0160000021005_wo.input_file_id,
                    c0160000021005_wo.info_system_id,
                    c0160000021005_wo.sk_agrmnt
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021005_wo
                  WHERE 1 = 1 AND NOT (COALESCE(c0160000021005_wo.ovd_wo, 0::numeric) = 0::numeric AND COALESCE(c0160000021005_wo.ovd_int_wo, 0::numeric) = 0::numeric)) _t) c5 ON 1 = 1 AND bb.sk_agrmnt = c5.sk_agrmnt AND bb.record_date_from >= c5.record_date_from AND bb.record_date_from <= c5.record_date_from
     LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.""w0160000021007_agmt_mtr_hst$w4"" _tgt ON 1 = 1 AND bb.sk_agrmnt = _tgt.agrmnt_id AND bb.record_date_from >= _tgt.acct_bal_summary_start_dt AND bb.record_date_from <= _tgt.acct_bal_summary_end_dt;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021002_acct_cred_limit.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021002_acct_cred_limit AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    4::smallint AS limit_type_id,
    src.record_date_from AS cred_limit_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS cred_limit_end_dt,
    (( SELECT min(k_crncy_nk03.tgt_id) AS min
           FROM s_grnplm_as_t_didsd_016_db_tmd.k_crncy_nk03
          WHERE 1 = 1 AND k_crncy_nk03.nk03_w4_currency_cd = '810'::text AND k_crncy_nk03.info_system_inst_cd = '000001'::text AND k_crncy_nk03.info_system_type_cd = '016'::text))::integer AS cred_limit_crncy_id,
    src.full_crlim::numeric(26,4) AS cred_limit_amt,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1002.sk_agrmnt,
            c1002.record_date_from,
            c1002.record_date_to,
            c1002.full_crlim,
            c1002.info_system_id,
            c1002.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1002.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr c1002
          WHERE c1002.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021002_acct_rate.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021002_acct_rate AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    1::smallint AS rate_type_id,
    2::smallint AS bal_cat_type_id,
    src.record_date_from AS acct_rate_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS acct_rate_end_dt,
        CASE
            WHEN (src.ln_int_rate >= (-999.999999999999) AND src.ln_int_rate <= 999.999999999999) OR src.ln_int_rate IS NULL THEN src.ln_int_rate
            ELSE (-999.999999999999)
        END::numeric(15,12) AS acct_rate,
    6::smallint AS acct_rate_time_period_id,
    (-1) AS intrst_calc_type_id,
    (-1) AS term_compliance_type_id,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1002.sk_agrmnt,
            c1002.record_date_from,
            c1002.record_date_to,
            c1002.ln_int_rate,
            c1002.info_system_id,
            c1002.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1002.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr c1002
          WHERE 1 = 1 AND c1002.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021002_agmt_cls_asc.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021002_agmt_cls_asc AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1028)::smallint AS agrmnt_clsfctn_id,
    src.record_date_from AS agrmnt_class_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_class_end_dt,
    COALESCE(src.sk_agrmnt_cls_val_early_ovd, (-1)::bigint) AS agrmnt_class_val_id,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1002.sk_agrmnt,
            c1002.record_date_from,
            c1002.record_date_to,
            c1002.sk_agrmnt_cls_val_early_ovd,
            c1002.info_system_id,
            c1002.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1002.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr c1002
          WHERE 1 = 1 AND c1002.sk_agrmnt IS NOT NULL) src
UNION ALL
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1029)::smallint AS agrmnt_clsfctn_id,
    src.record_date_from AS agrmnt_class_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_class_end_dt,
    COALESCE(src.sk_agrmnt_cls_val, (-1)::bigint) AS agrmnt_class_val_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1002.sk_agrmnt,
            c1002.record_date_from,
            c1002.record_date_to,
            c1002.sk_agrmnt_cls_val,
            c1002.info_system_id,
            c1002.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1002.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr c1002
          WHERE c1002.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021002_agmt_cls_val.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021002_agmt_cls_val AS 
 SELECT src.sk_agrmnt_cls_val_early_ovd AS agrmnt_class_val_id,
    (-1028)::smallint AS agrmnt_clsfctn_id,
    src.early_ovd::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000021002_attr.sk_agrmnt_cls_val_early_ovd,
            c0160000021002_attr.early_ovd,
            c0160000021002_attr.info_system_id,
            min(c0160000021002_attr.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr
          WHERE c0160000021002_attr.sk_agrmnt_cls_val_early_ovd IS NOT NULL
          GROUP BY c0160000021002_attr.sk_agrmnt_cls_val_early_ovd, c0160000021002_attr.early_ovd, c0160000021002_attr.info_system_id) src
UNION ALL
 SELECT src.sk_agrmnt_cls_val AS agrmnt_class_val_id,
    (-1029)::smallint AS agrmnt_clsfctn_id,
    src.credit_attr::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000021002_attr.sk_agrmnt_cls_val,
            c0160000021002_attr.credit_attr,
            c0160000021002_attr.info_system_id,
            min(c0160000021002_attr.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr
          WHERE c0160000021002_attr.sk_agrmnt_cls_val IS NOT NULL
          GROUP BY c0160000021002_attr.sk_agrmnt_cls_val, c0160000021002_attr.credit_attr, c0160000021002_attr.info_system_id) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021002_agrmnt.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021002_agrmnt AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
        CASE
            WHEN src._1002_contract_idt IS NULL THEN src.contract_expiration_dt
            ELSE src.acnt_date_expire
        END AS contract_expiration_dt,
        CASE
            CASE
                WHEN src._1003_contract_idt IS NULL THEN src.status_id
                ELSE src._1003_status_id
            END
            WHEN 51 THEN 10
            ELSE 9
        END AS acct_current_stts_type_id,
    src.crlim_date_open AS way4_f9_crlim_dt,
    'Y'::text::character(1) AS way4_f9_flag,
    src.agreement_open_date AS acct_open_dt,
    ( SELECT max(k_info_system.tgt_id) AS max
           FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
          WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000001'::text) AS acct_src_id,
    NULL::date AS acct_close_dt,
    NULL::date AS acct_signed_dt,
    src.agreement_number::character varying(255) AS agrmnt_num,
    COALESCE(src.contract_idt, src.agreement_id_w4::numeric)::bigint::character varying(255) AS host_agrmnt_cd,
    NULL::character varying(255) AS host_agrmnt_guid,
    1 AS agrmnt_categ_id,
    '1900-01-01'::date AS agrmnt_rec_start_dt,
    '9999-12-31'::date AS agrmnt_rec_end_dt,
    NULL::character(1) AS bki_grant_flag,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system AS info_system_id
   FROM ( SELECT COALESCE(_src.sk_agrmnt, c10.sk_agreement) AS sk_agrmnt,
            _src._1002_contract_idt,
            _src._1003_contract_idt,
            _src.contract_idt,
            _src.acnt_date_expire,
            _src.crlim_date_open,
            ( SELECT max(c0160000022007_status.status_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000022007_status
                  WHERE 1 = 1 AND c0160000022007_status.status_category = 'A'::text AND substr(c0160000022007_status.status_name, 1, 1) = _src.contr_status) AS _1003_status_id,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000002'::text) AS sk_info_system,
            c10.agreement_number,
            c10.agreement_id_w4,
            c10.agreement_open_date,
            c10.status_id,
            COALESCE(_src.acnt_date_expire, c10.date_expire) AS contract_expiration_dt,
            COALESCE(_src.input_file_id, c10.sk_input_file) AS sk_input_file
           FROM ( SELECT _sk_agrmnt.tgt_id AS sk_agrmnt,
                    COALESCE(c1002.contract_idt, c1003.contract_idt) AS contract_idt,
                    c1002.contract_idt AS _1002_contract_idt,
                    c1003.contract_idt AS _1003_contract_idt,
                    c1002.acnt_date_expire,
                    c1002.crlim_date_open,
                    c1003.contr_status,
                    COALESCE(c1002.input_file_id, c1003.input_file_id) AS input_file_id
                   FROM ( SELECT l016_1002_attr.contract_idt,
                            l016_1002_attr.record_date_to,
                            l016_1002_attr.record_date_from,
                            l016_1002_attr.acnt_date_expire,
                            l016_1002_attr.crlim_date_open,
                            l016_1002_attr.dl,
                            l016_1002_attr.input_file_id
                           FROM s_grnplm_as_t_didsd_016_db_stg.l016_1002_attr
                          WHERE 1 = 1 AND l016_1002_attr.record_date_to = '9999-12-31'::date) c1002
                     FULL JOIN ( SELECT l016_1003_ext_attr.contract_idt,
                            l016_1003_ext_attr.record_date_to,
                            l016_1003_ext_attr.record_date_from,
                            l016_1003_ext_attr.contr_status,
                            l016_1003_ext_attr.input_file_id
                           FROM s_grnplm_as_t_didsd_016_db_stg.l016_1003_ext_attr
                          WHERE 1 = 1 AND l016_1003_ext_attr.record_date_to = '9999-12-31'::date) c1003 ON c1003.contract_idt = c1002.contract_idt
                     LEFT JOIN ( SELECT k_agrmnt_nk07.tgt_id,
                            k_agrmnt_nk07.nk07_agreement_id_w4
                           FROM s_grnplm_as_t_didsd_016_db_tmd.k_agrmnt_nk07
                          WHERE k_agrmnt_nk07.info_system_inst_cd = '000001'::text AND k_agrmnt_nk07.info_system_type_cd = '016'::text AND k_agrmnt_nk07.nk07_agreement_id_w4 IS NOT NULL) _sk_agrmnt ON _sk_agrmnt.nk07_agreement_id_w4::numeric = COALESCE(c1002.contract_idt, c1003.contract_idt)) _src
             LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000022010_contract c10 ON 1 = 1 AND c10.agreement_id_w4::numeric = _src.contract_idt) src
  WHERE src.sk_agrmnt IS NOT NULL;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021002_agrmnt_to_coa.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021002_agrmnt_to_coa AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    src.sk_coa AS coa_id,
    src.record_date_from AS agrmnt_gl_acct_start_dt,
    (-1018)::bigint AS coa_to_agrmnt_role_id,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_gl_acct_end_dt,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1002.sk_agrmnt,
                CASE
                    WHEN c1002.loan_number IS NULL OR c1002.acnt_date_open IS NULL THEN (-1)::bigint
                    ELSE c1002.sk_coa
                END AS sk_coa,
            c1002.record_date_from,
            c1002.record_date_to,
            c1002.info_system_id,
            c1002.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1002.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr c1002
          WHERE c1002.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021002_agr_text_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021002_agr_text_hist AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1006) AS agrmnt_text_type_id,
    src.record_date_from AS agrmnt_text_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_text_end_dt,
    src.etsm_id::character varying(4000) AS agrmnt_txt,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1002.sk_agrmnt,
            c1002.record_date_from,
            c1002.record_date_to,
            c1002.etsm_id,
            c1002.info_system_id,
            c1002.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1002.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr c1002) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021002_coa.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021002_coa AS 
 WITH cte AS (
         SELECT c0160000021002_attr.sk_coa AS coa_id,
            substr(c0160000021002_attr.loan_number, 1, 50)::character varying(50) AS coa_num,
            NULL::character varying(512) AS coa_name,
            c0160000021002_attr.acnt_date_open AS coa_start_dt,
            NULL::date AS coa_end_dt,
            NULL::character(3) AS summary_coa_ind,
            NULL::character varying(50) AS coa_src_id,
            NULL::integer AS crncy_id,
            NULL::bigint AS gl_main_acct_id,
            NULL::integer AS pl_rpt_cd_id,
            NULL::bigint AS gl_int_org_pty_id,
            'N'::text::character(1) AS deleted_flag,
            'I'::character(1) AS action_cd,
            c0160000021002_attr.input_file_id,
            c0160000021002_attr.info_system_id,
            row_number() OVER (PARTITION BY c0160000021002_attr.sk_coa ORDER BY c0160000021002_attr.record_date_to DESC) AS qualify_1
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021002_attr
          WHERE 1 = 1 AND c0160000021002_attr.sk_coa IS NOT NULL AND c0160000021002_attr.loan_number IS NOT NULL AND c0160000021002_attr.acnt_date_open IS NOT NULL
        )
 SELECT cte.coa_id,
    cte.coa_num,
    cte.coa_name,
    cte.coa_start_dt,
    cte.coa_end_dt,
    cte.summary_coa_ind,
    cte.coa_src_id,
    cte.crncy_id,
    cte.gl_main_acct_id,
    cte.pl_rpt_cd_id,
    cte.gl_int_org_pty_id,
    cte.deleted_flag,
    cte.action_cd,
    cte.input_file_id,
    cte.info_system_id
   FROM cte
  WHERE cte.qualify_1 = 1;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021002_pty_access_dev.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021002_pty_access_dev AS 
 WITH cte AS (
         SELECT b0160000021002_attr.contract_idt,
            b0160000021002_attr.dl,
            b0160000021002_attr.record_date_from,
            max(b0160000021002_attr.dl) OVER (PARTITION BY b0160000021002_attr.contract_idt ORDER BY b0160000021002_attr.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_dl,
            rank() OVER (PARTITION BY b0160000021002_attr.contract_idt ORDER BY b0160000021002_attr.record_date_from) AS rank_dl,
            b0160000021002_attr.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021002_attr
        ), cte_1 AS (
         SELECT _b.osb_id,
            _b.tb_number,
            _b.tb_old_number,
            _b.osb_number,
            _b.osb_name,
            _b.info_system_type_cd,
            _b.info_system_inst_cd,
            _b.input_file_name,
            _b.input_file_id,
            _b.info_system_id,
            _b.workflow_run_id,
            _b.current_load_flag,
            min(substr(_b.input_file_name, 12, 8)::date - 1) OVER (PARTITION BY _b.osb_id ORDER BY _b.input_file_name ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS actual_from_x,
            min(substr(_b.input_file_name, 12, 8)::date - 1) OVER (PARTITION BY _b.osb_id ORDER BY _b.input_file_name ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING) AS actual_to_x
           FROM s_grnplm_as_t_didsd_016_db_stg.s016_0001_branch _b
        ), cte_2 AS (
         SELECT _b.osb_id,
            _b.tb_number,
            _b.tb_old_number,
            _b.osb_number,
            _b.osb_name,
            _b.info_system_type_cd,
            _b.info_system_inst_cd,
            _b.input_file_name,
            _b.input_file_id,
            _b.info_system_id,
            _b.workflow_run_id,
            _b.current_load_flag,
            min(substr(_b.input_file_name, 12, 8)::date - 1) OVER (PARTITION BY _b.osb_id ORDER BY _b.input_file_name ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS actual_from_x,
            min(substr(_b.input_file_name, 12, 8)::date - 1) OVER (PARTITION BY _b.osb_id ORDER BY _b.input_file_name ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING) AS actual_to_x
           FROM s_grnplm_as_t_didsd_016_db_stg.s016_0001_branch _b
        ), cte_3 AS (
         SELECT
                CASE
                    WHEN c1002.sk_party_vsp > 0 THEN c1002.sk_party_vsp
                    WHEN _s08.sk_party_vsp > 0 THEN _s08.sk_party_vsp
                    ELSE c10.sk_party_vsp
                END AS sk_pty_vsp,
            _s08.sk_access_device,
            c1002.contract_idt,
            c1002.record_date_from,
            c1002.input_file_id,
            row_number() OVER (PARTITION BY _s08.sk_access_device ORDER BY _s08.card_open_date_w4 DESC, _s08.last_modified_dt DESC) AS access_device_rank
           FROM ( SELECT _b1002.contract_idt,
                    _b1002.record_date_from,
                    COALESCE(_sk_pty_vsp.tgt_id, (-1)::bigint) AS sk_party_vsp,
                    _b1002.input_file_id
                   FROM ( SELECT b1002.contract_idt,
                            b1002.dl,
                            b1002.record_date_from,
                            b1002.prev_dl,
                            b1002.rank_dl,
                            b1002.input_file_id,
                            b1002.is_eq,
                            _b.tb_old_number,
                            _b.osb_number,
                            COALESCE(_b.tb_number || substr(b1002.dl, 3), b1002.dl) AS vsp_full_number
                           FROM ( SELECT cte.contract_idt,
                                    cte.dl,
                                    cte.record_date_from,
                                    cte.prev_dl,
                                    cte.rank_dl,
                                    cte.input_file_id,
CASE
 WHEN cte.dl = cte.prev_dl OR (cte.dl IS NULL AND cte.prev_dl IS NULL AND cte.rank_dl > 1) THEN 1
 ELSE 0
END AS is_eq
                                   FROM cte) b1002
                             LEFT JOIN ( SELECT _b_1.osb_id,
                                    _b_1.tb_number,
                                    _b_1.tb_old_number,
                                    _b_1.osb_number,
                                    _b_1.osb_name,
                                    _b_1.info_system_type_cd,
                                    _b_1.info_system_inst_cd,
                                    _b_1.input_file_name,
                                    _b_1.input_file_id,
                                    _b_1.info_system_id,
                                    _b_1.workflow_run_id,
                                    _b_1.current_load_flag,
                                    _b_1.actual_from_x,
                                    _b_1.actual_to_x,
CASE
 WHEN _b_1.actual_from_x IS NOT NULL THEN substr(_b_1.input_file_name, 12, 8)::date
 ELSE '1900-01-01'::date
END AS actual_from,
                                    COALESCE(_b_1.actual_to_x, '9999-12-31'::date) AS actual_to
                                   FROM cte_1 _b_1) _b ON 1 = 1 AND substr(b1002.dl, 1, 2) = _b.tb_old_number AND substr(b1002.dl, 3, 4) = _b.osb_number AND b1002.record_date_from >= _b.actual_from AND b1002.record_date_from <= _b.actual_to
                          WHERE 1 = 1 AND b1002.is_eq = 0) _b1002
                     LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.k_pty_nk13 _sk_pty_vsp ON 1 = 1 AND COALESCE(_sk_pty_vsp.nk13_vsp_full_number, ''::text) = _b1002.vsp_full_number AND _sk_pty_vsp.info_system_type_cd = '016'::text AND _sk_pty_vsp.info_system_inst_cd = '000001'::text) c1002
             LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000022010_contract c10 ON 1 = 1 AND c10.agreement_id_w4::numeric = c1002.contract_idt
             LEFT JOIN ( SELECT _s.last_modified_dt,
                    _s.card_open_date_w4,
                    COALESCE((min(_s.card_open_date_w4) OVER (PARTITION BY _s.contract_id_w4 ORDER BY _s.card_open_date_w4, _s.last_modified_dt, _s.card_id_w4 ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS card_ak255068_end_dt,
                    _s.contract_id_w4,
                    COALESCE(_sk_acc_dev.tgt_id,
                        CASE
                            WHEN _s.card_number IS NULL THEN (-1)
                            ELSE (-999)
                        END::bigint) AS sk_access_device,
                    COALESCE(_sk_pty_vsp.tgt_id,
                        CASE
                            WHEN _s.osb_tb_number IS NULL OR _s.osb_number IS NULL OR _s.card_vsp_number IS NULL THEN (-1)
                            ELSE (-999)
                        END::bigint) AS sk_party_vsp,
                    _s.input_file_id
                   FROM s_grnplm_as_t_didsd_016_db_stg.s016_0008_card _s
                     JOIN s_grnplm_as_t_didsd_016_db_tmd.k_access_device_nk10 _sk_acc_dev ON 1 = 1 AND _sk_acc_dev.nk10_card_number IS NOT NULL AND _sk_acc_dev.nk10_card_number = _s.card_number AND _sk_acc_dev.info_system_type_cd = '016'::text AND _sk_acc_dev.info_system_inst_cd = '000001'::text
                     LEFT JOIN ( SELECT _b_1.osb_id,
                            _b_1.tb_number,
                            _b_1.tb_old_number,
                            _b_1.osb_number,
                            _b_1.osb_name,
                            _b_1.info_system_type_cd,
                            _b_1.info_system_inst_cd,
                            _b_1.input_file_name,
                            _b_1.input_file_id,
                            _b_1.info_system_id,
                            _b_1.workflow_run_id,
                            _b_1.current_load_flag,
                            _b_1.actual_from_x,
                            _b_1.actual_to_x,
                                CASE
                                    WHEN _b_1.actual_from_x IS NOT NULL THEN substr(_b_1.input_file_name, 12, 8)::date
                                    ELSE '1900-01-01'::date
                                END AS actual_from,
                            COALESCE(_b_1.actual_to_x, '9999-12-31'::date) AS actual_to
                           FROM cte_2 _b_1) _b ON 1 = 1 AND _s.osb_tb_number = _b.tb_old_number AND _s.osb_number = _b.osb_number AND _b.info_system_type_cd = '016'::text AND _b.info_system_inst_cd = '000001'::text AND substr(_s.input_file_name, 12, 8)::date >= _b.actual_from AND substr(_s.input_file_name, 12, 8)::date <= _b.actual_to
                     LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.k_pty_nk13 _sk_pty_vsp ON 1 = 1 AND COALESCE(_sk_pty_vsp.nk13_vsp_full_number, ''::text) = btrim((COALESCE(_b.tb_number, ' '::text) || btrim(COALESCE(_b.osb_number, ' '::text))) || btrim(COALESCE(_s.card_vsp_number, ' '::text))) AND _sk_pty_vsp.info_system_type_cd = '016'::text AND _sk_pty_vsp.info_system_inst_cd = '000001'::text) _s08 ON 1 = 1 AND c1002.contract_idt = _s08.contract_id_w4::numeric AND c1002.record_date_from >= _s08.card_open_date_w4 AND c1002.record_date_from <= _s08.card_ak255068_end_dt
          WHERE 1 = 1
        )
 SELECT src.sk_pty_vsp AS pty_id,
    src.sk_access_device AS access_device_id,
    1::smallint AS pty_access_device_role_id,
    src.record_date_from AS pty_access_device_start_dt,
    src.record_date_to AS pty_access_device_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system AS info_system_id
   FROM ( SELECT _t.sk_pty_vsp,
            _t.sk_access_device,
            _t.record_date_from,
            _t.input_file_id AS sk_input_file,
            COALESCE((min(_t.record_date_from) OVER (PARTITION BY _t.sk_access_device ORDER BY _t.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS record_date_to,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000002'::text) AS sk_info_system,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = _t.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM ( SELECT cte_3.sk_pty_vsp,
                    cte_3.sk_access_device,
                    cte_3.contract_idt,
                    cte_3.record_date_from,
                    cte_3.input_file_id,
                    cte_3.access_device_rank
                   FROM cte_3
                  WHERE cte_3.sk_access_device > 0 AND cte_3.sk_pty_vsp IS NOT NULL) _t
          WHERE 1 = 1 AND _t.access_device_rank = 1) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021003_acct_stts_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021003_acct_stts_hist AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
        CASE src.status_id
            WHEN 51 THEN 10
            ELSE 9
        END AS acct_stts_type_id,
    src.record_date_from AS acct_stts_start_dt,
    src.record_date_to AS acct_stts_end_dt,
    src.sk_acct_stts_reason_type AS acct_stts_reason_id,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT _src.sk_agrmnt,
            _src.record_date_from,
            COALESCE(_src.record_date_to, '9999-12-31'::date) AS record_date_to,
            COALESCE(_src.status_id, _c10.status_id) AS status_id,
            COALESCE(_src.sk_acct_stts_reason_type, _c10.sk_acct_stts_reason_type) AS sk_acct_stts_reason_type,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000002'::text) AS info_system_id,
            _src.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = _src.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM ( SELECT _sk_agrmnt.tgt_id AS sk_agrmnt,
                    _s1003.record_date_from,
                    COALESCE((min(_s1003.record_date_from) OVER (PARTITION BY _s1003.contract_idt ORDER BY _s1003.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS record_date_to,
                    s07.status_id,
                    _sk_acct_stts_reason_tp.tgt_id AS sk_acct_stts_reason_type,
                    _s1003.input_file_id,
                    _s1003.contract_idt
                   FROM ( SELECT _t.contract_idt,
                            _t.record_date_from,
                            _t.contr_status,
                            max(_t.contr_status) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_contr_status,
                                CASE
                                    WHEN _t.contr_status = (max(_t.contr_status) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) THEN 1
                                    ELSE 0
                                END AS is_eq,
                            _t.input_file_id
                           FROM ( SELECT s1003.contract_idt,
                                    s1003.record_date_from,
                                    s1003.contr_status,
                                    s1003.input_file_id
                                   FROM s_grnplm_as_t_didsd_016_db_stg.l016_1003_ext_attr s1003
                                  WHERE 1 = 1) _t) _s1003
                     LEFT JOIN ( SELECT k_agrmnt_nk07.tgt_id,
                            k_agrmnt_nk07.nk07_agreement_id_w4
                           FROM s_grnplm_as_t_didsd_016_db_tmd.k_agrmnt_nk07
                          WHERE k_agrmnt_nk07.info_system_inst_cd = '000001'::text AND k_agrmnt_nk07.info_system_type_cd = '016'::text AND k_agrmnt_nk07.nk07_agreement_id_w4 IS NOT NULL) _sk_agrmnt ON 1 = 1 AND _sk_agrmnt.nk07_agreement_id_w4::numeric = _s1003.contract_idt
                     LEFT JOIN ( SELECT c0160000010007_status.status_id,
                            substr(c0160000010007_status.status_name, 1, 1) AS status_cd
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000010007_status
                          WHERE 1 = 1 AND c0160000010007_status.status_category = 'A'::text) s07 ON 1 = 1 AND s07.status_cd = _s1003.contr_status
                     LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.k_acct_stts_reason_type_nk01 _sk_acct_stts_reason_tp ON 1 = 1 AND _sk_acct_stts_reason_tp.nk01_w4_status_id = s07.status_id AND _sk_acct_stts_reason_tp.nk01_w4_status_id IS NOT NULL AND _sk_acct_stts_reason_tp.info_system_type_cd = '016'::text AND _sk_acct_stts_reason_tp.info_system_inst_cd = '000001'::text
                  WHERE 1 = 1 AND _s1003.is_eq = 0 AND _sk_agrmnt.tgt_id IS NOT NULL) _src
             LEFT JOIN ( SELECT c10.sk_agreement,
                    c10.sk_acct_stts_reason_type,
                    c10.status_id,
                    c10.sk_input_file AS input_file_id,
                    c10.sk_info_system AS info_system_id,
                    c10.last_modified_dt,
                    c10.agreement_id_w4
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000010010_contract c10
                  WHERE 1 = 1 AND c10.sk_agreement > 0) _c10 ON 1 = 1 AND _c10.agreement_id_w4::numeric = _src.contract_idt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021004_acct_acct_grp.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021004_acct_acct_grp AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    COALESCE(src.sk_acct_grp, (-1)::bigint) AS acct_grp_id,
    src.record_date_from AS acct_assoc_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS acct_assoc_end_dt,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1004.sk_agrmnt,
            c1004.sk_acct_grp,
            c1004.record_date_from,
            c1004.record_date_to,
            c1004.info_system_id,
            c1004.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1004.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021004_res_wroff c1004
          WHERE 1 = 1 AND c1004.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021004_acct_grp.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021004_acct_grp AS 
 SELECT src.sk_acct_grp AS acct_grp_id,
    NULL::bigint AS prnt_acct_grp_id,
    src.portfolio_name::character varying(512) AS acct_grp_name,
    '1900-01-01'::date AS acct_grp_start_dt,
    '9999-12-31'::date AS acct_grp_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT _sk_acct_grp.tgt_id AS sk_acct_grp,
            _b.portfolio_name,
            _b.input_file_id,
            _b.info_system_id
           FROM ( SELECT b0160000021004_res_wroff.portfolio_name,
                    max(b0160000021004_res_wroff.info_system_id) AS info_system_id,
                    max(b0160000021004_res_wroff.input_file_id) AS input_file_id
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021004_res_wroff
                  WHERE 1 = 1
                  GROUP BY b0160000021004_res_wroff.portfolio_name) _b
             JOIN ( SELECT k_acct_grp_nk19.tgt_id,
                    k_acct_grp_nk19.nk19_w4_provision_code
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_acct_grp_nk19
                  WHERE k_acct_grp_nk19.info_system_inst_cd = '000001'::text AND k_acct_grp_nk19.info_system_type_cd = '016'::text AND k_acct_grp_nk19.nk19_w4_provision_code IS NOT NULL) _sk_acct_grp ON 1 = 1 AND _sk_acct_grp.nk19_w4_provision_code = _b.portfolio_name
          WHERE 1 = 1 AND _sk_acct_grp.tgt_id IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021004_acct_rate.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021004_acct_rate AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    1::smallint AS rate_type_id,
    1::smallint AS bal_cat_type_id,
    src.record_date_from AS acct_rate_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS acct_rate_end_dt,
        CASE
            WHEN (src.reserv_loan_rate >= (-999.999999999999) AND src.reserv_loan_rate <= 999.999999999999) OR src.reserv_loan_rate IS NULL THEN src.reserv_loan_rate
            ELSE (-999.999999999999)
        END::numeric(15,12) AS acct_rate,
    6::smallint AS acct_rate_time_period_id,
    (-1) AS intrst_calc_type_id,
    (-1) AS term_compliance_type_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1004.sk_agrmnt,
            c1004.record_date_from,
            c1004.record_date_to,
            c1004.reserv_loan_rate,
            c1004.info_system_id,
            c1004.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1004.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021004_res_wroff c1004
          WHERE 1 = 1 AND c1004.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021004_agmt_cls_asc.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021004_agmt_cls_asc AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    5::smallint AS agrmnt_clsfctn_id,
    src.record_date_from AS agrmnt_class_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000029999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000029999_params
              WHERE b0160000029999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_class_end_dt,
    COALESCE(src.sk_agrmnt_cls_val, (-1)::bigint) AS agrmnt_class_val_id,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c1004.sk_agrmnt,
            c1004.record_date_from,
            c1004.record_date_to,
            c1004.sk_agrmnt_cls_val,
            c1004.info_system_id,
            c1004.input_file_id,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1004.contract_idt
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021004_res_wroff c1004
          WHERE 1 = 1 AND c1004.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021004_agmt_cls_val.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021004_agmt_cls_val AS 
 SELECT src.sk_agrmnt_cls_val AS agrmnt_class_val_id,
    5::smallint AS agrmnt_clsfctn_id,
    src.beh_type_category::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000021004_res_wroff.sk_agrmnt_cls_val,
            c0160000021004_res_wroff.beh_type_category,
            c0160000021004_res_wroff.info_system_id,
            min(c0160000021004_res_wroff.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021004_res_wroff
          WHERE 1 = 1 AND c0160000021004_res_wroff.sk_agrmnt_cls_val IS NOT NULL
          GROUP BY c0160000021004_res_wroff.sk_agrmnt_cls_val, c0160000021004_res_wroff.beh_type_category, c0160000021004_res_wroff.info_system_id) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021007_acct_acct_grp.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021007_acct_acct_grp AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000021007_contract_ids.sk_agrmnt,
            max(c0160000021007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000021007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021007_contract_ids
          WHERE c0160000021007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000021007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021007_acct_cred_limit.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021007_acct_cred_limit AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    src.limit_type_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c1007.sk_agrmnt,
            c1007.sk_info_system,
            c1007.sk_input_file,
            _limit_type.limit_type_id
           FROM ( SELECT c0160000021007_contract_ids.sk_agrmnt,
                    max(c0160000021007_contract_ids.info_system_id) AS sk_info_system,
                    max(c0160000021007_contract_ids.input_file_id) AS sk_input_file
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021007_contract_ids
                  WHERE c0160000021007_contract_ids.sk_agrmnt IS NOT NULL
                  GROUP BY c0160000021007_contract_ids.sk_agrmnt) c1007
             CROSS JOIN ( SELECT s.limit_type_id
                   FROM ( SELECT s1.limit_type_id
                           FROM ( SELECT 2::smallint AS limit_type_id) s1
                        UNION
                         SELECT s2.limit_type_id
                           FROM ( SELECT 4::smallint AS limit_type_id) s2) s) _limit_type) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021007_acct_pymnt_opt.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021007_acct_pymnt_opt AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    1::smallint AS pymnt_option_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000021007_contract_ids.sk_agrmnt,
            max(c0160000021007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000021007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021007_contract_ids
          WHERE c0160000021007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000021007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021007_acct_rate.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021007_acct_rate AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    1::smallint AS rate_type_id,
    src.bal_cat_type_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c1007.sk_agrmnt,
            c1007.sk_info_system,
            c1007.sk_input_file,
            _bal_cat_type.bal_cat_type_id
           FROM ( SELECT c0160000021007_contract_ids.sk_agrmnt,
                    max(c0160000021007_contract_ids.info_system_id) AS sk_info_system,
                    max(c0160000021007_contract_ids.input_file_id) AS sk_input_file
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021007_contract_ids
                  WHERE c0160000021007_contract_ids.sk_agrmnt IS NOT NULL
                  GROUP BY c0160000021007_contract_ids.sk_agrmnt) c1007
             CROSS JOIN ( SELECT s.bal_cat_type_id
                   FROM ( SELECT s1.bal_cat_type_id
                           FROM ( SELECT 1::smallint AS bal_cat_type_id) s1
                        UNION
                         SELECT s2.bal_cat_type_id
                           FROM ( SELECT 2::smallint AS bal_cat_type_id) s2) s) _bal_cat_type) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021007_acct_stts_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021007_acct_stts_hist AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000021007_contract_ids.sk_agrmnt,
            max(c0160000021007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000021007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021007_contract_ids
          WHERE c0160000021007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000021007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021007_agmt_cls_asc.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021007_agmt_cls_asc AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    src.agrmnt_clsfctn_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c07.sk_agrmnt,
            c07.sk_info_system,
            c07.sk_input_file,
            agrmnt_clsfctn.agrmnt_clsfctn_id
           FROM ( SELECT c0160000021007_contract_ids.sk_agrmnt,
                    max(c0160000021007_contract_ids.info_system_id) AS sk_info_system,
                    max(c0160000021007_contract_ids.input_file_id) AS sk_input_file
                   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021007_contract_ids
                  WHERE c0160000021007_contract_ids.sk_agrmnt IS NOT NULL
                  GROUP BY c0160000021007_contract_ids.sk_agrmnt) c07
             CROSS JOIN ( SELECT s.agrmnt_clsfctn_id
                   FROM ( SELECT s1.agrmnt_clsfctn_id
                           FROM ( SELECT (-1029)::smallint AS agrmnt_clsfctn_id) s1
                        UNION
                         SELECT s2.agrmnt_clsfctn_id
                           FROM ( SELECT (-1028)::smallint AS agrmnt_clsfctn_id) s2
                        UNION
                         SELECT s3.agrmnt_clsfctn_id
                           FROM ( SELECT 5::smallint AS agrmnt_clsfctn_id) s3) s) agrmnt_clsfctn) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021007_agmt_mtr_hst_w4.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021007_agmt_mtr_hst_w4 AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000021007_contract_ids.sk_agrmnt,
            max(c0160000021007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000021007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021007_contract_ids
          WHERE c0160000021007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000021007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021007_agrmnt_to_coa.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021007_agrmnt_to_coa AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1018)::bigint AS coa_to_agrmnt_role_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000021007_contract_ids.sk_agrmnt,
            max(c0160000021007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000021007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021007_contract_ids
          WHERE c0160000021007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000021007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021007_agr_text_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021007_agr_text_hist AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1006) AS agrmnt_text_type_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c0160000021007_contract_ids.sk_agrmnt,
            (-1006) AS agrmnt_text_type_id,
            max(c0160000021007_contract_ids.info_system_id) AS sk_info_system,
            max(c0160000021007_contract_ids.input_file_id) AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021007_contract_ids
          WHERE c0160000021007_contract_ids.sk_agrmnt IS NOT NULL
          GROUP BY c0160000021007_contract_ids.sk_agrmnt) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021007_pty_access_dev.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021007_pty_access_dev AS 
 SELECT src.sk_access_device AS access_device_id,
    1::smallint AS pty_access_device_role_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( WITH cte AS (
                 SELECT c08.sk_access_device,
                    1 AS pty_access_device_role_id,
                    b1007.input_file_id,
                    b1007.info_system_id,
                    row_number() OVER (PARTITION BY c08.contract_id_w4 ORDER BY c08.card_open_date_w4 DESC, c08.last_modified_dt DESC) AS qualify_1
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                     JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000010008_card c08 ON b1007.contract_idt = c08.contract_id_w4::numeric
                  WHERE 1 = 1 AND c08.sk_access_device > 0
                )
         SELECT cte.sk_access_device,
            cte.pty_access_device_role_id,
            cte.input_file_id,
            cte.info_system_id
           FROM cte
          WHERE cte.qualify_1 = 1) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021008_acct_rate.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021008_acct_rate AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    4::smallint AS rate_type_id,
    1::smallint AS bal_cat_type_id,
    src.banking_date AS acct_rate_start_dt,
    src.date_to AS acct_rate_end_dt,
        CASE
            WHEN (src.av_rate_on_b >= (-999.999999999999) AND src.av_rate_on_b <= 999.999999999999) OR src.av_rate_on_b IS NULL THEN src.av_rate_on_b
            ELSE (-999.999999999999)
        END::numeric(15,12) AS acct_rate,
    (-1)::smallint AS acct_rate_time_period_id,
    (-1) AS intrst_calc_type_id,
    (-1) AS term_compliance_type_id,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT _src.sk_agrmnt,
            _src.banking_date,
            _src.av_rate_on_b,
            COALESCE((min(_src.banking_date) OVER (PARTITION BY _src.sk_agrmnt ORDER BY _src.banking_date ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS date_to,
            _src.sk_info_system,
            _src.sk_input_file,
            _src.action_cd
           FROM ( WITH cte AS (
                         SELECT c1008.sk_agrmnt,
                            c1008.banking_date,
                            c1008.av_rate_on_b,
                            min(c1008.av_rate_on_b) OVER (PARTITION BY c1008.sk_agrmnt ORDER BY c1008.banking_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_rate,
                            c1008.info_system_id AS sk_info_system,
                            c1008.input_file_id AS sk_input_file,
                            COALESCE(( SELECT 'H'::text AS text
                                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                                  WHERE b1007.contract_idt = c1008.acnt_contract_id
                                  GROUP BY 'H'::text), 'I'::text) AS action_cd,
                                CASE
                                    WHEN c1008.av_rate_on_b = (min(c1008.av_rate_on_b) OVER (PARTITION BY c1008.sk_agrmnt ORDER BY c1008.banking_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) OR (c1008.av_rate_on_b IS NULL AND (min(c1008.av_rate_on_b) OVER (PARTITION BY c1008.sk_agrmnt ORDER BY c1008.banking_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) IS NULL) THEN 0
                                    ELSE 1
                                END AS qualify_1
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021008_rep_reserve c1008
                          WHERE 1 = 1 AND c1008.sk_agrmnt IS NOT NULL
                        )
                 SELECT cte.sk_agrmnt,
                    cte.banking_date,
                    cte.av_rate_on_b,
                    cte.prev_rate,
                    cte.sk_info_system,
                    cte.sk_input_file,
                    cte.action_cd
                   FROM cte
                  WHERE cte.qualify_1 = 1) _src) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021008_acct_rate_off_b.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021008_acct_rate_off_b AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    5::smallint AS rate_type_id,
    1::smallint AS bal_cat_type_id,
    src.banking_date AS acct_rate_start_dt,
    src.date_to AS acct_rate_end_dt,
        CASE
            WHEN (src.calc_rate_off_b >= (-999.999999999999) AND src.calc_rate_off_b <= 999.999999999999) OR src.calc_rate_off_b IS NULL THEN src.calc_rate_off_b
            ELSE (-999.999999999999)
        END::numeric(15,12) AS acct_rate,
    (-1)::smallint AS acct_rate_time_period_id,
    (-1) AS intrst_calc_type_id,
    (-1) AS term_compliance_type_id,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT _src.sk_agrmnt,
            _src.banking_date,
            _src.calc_rate_off_b,
            COALESCE((min(_src.banking_date) OVER (PARTITION BY _src.sk_agrmnt ORDER BY _src.banking_date ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS date_to,
            _src.sk_info_system,
            _src.sk_input_file,
            _src.action_cd
           FROM ( WITH cte AS (
                         SELECT c1008.sk_agrmnt,
                            c1008.banking_date,
                            c1008.calc_rate_off_b,
                            min(c1008.calc_rate_off_b) OVER (PARTITION BY c1008.sk_agrmnt ORDER BY c1008.banking_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_rate,
                            c1008.info_system_id AS sk_info_system,
                            c1008.input_file_id AS sk_input_file,
                            COALESCE(( SELECT 'H'::text AS text
                                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                                  WHERE b1007.contract_idt = c1008.acnt_contract_id
                                  GROUP BY 'H'::text), 'I'::text) AS action_cd,
                                CASE
                                    WHEN c1008.calc_rate_off_b = (min(c1008.calc_rate_off_b) OVER (PARTITION BY c1008.sk_agrmnt ORDER BY c1008.banking_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) OR (c1008.calc_rate_off_b IS NULL AND (min(c1008.calc_rate_off_b) OVER (PARTITION BY c1008.sk_agrmnt ORDER BY c1008.banking_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) IS NULL) THEN 0
                                    ELSE 1
                                END AS qualify_1
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021008_rep_reserve c1008
                          WHERE 1 = 1 AND c1008.sk_agrmnt IS NOT NULL
                        )
                 SELECT cte.sk_agrmnt,
                    cte.banking_date,
                    cte.calc_rate_off_b,
                    cte.prev_rate,
                    cte.sk_info_system,
                    cte.sk_input_file,
                    cte.action_cd
                   FROM cte
                  WHERE cte.qualify_1 = 1) _src) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021008_agmt_class_val.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021008_agmt_class_val AS 
 SELECT src.sk_agrmnt_class_val AS agrmnt_class_val_id,
    (-1042)::smallint AS agrmnt_clsfctn_id,
    src.class_val_cd::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
        CASE
            WHEN src.class_val_cd = '1'::text THEN '3 ЭТАП (КОРЗИНА)'::text
            ELSE src.class_val_cd
        END::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c1008.sk_agrmnt_class_val,
            c1008.stage_3_flag AS class_val_cd,
            min(c1008.input_file_id) AS sk_input_file,
            min(c1008.info_system_id) AS sk_info_system
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021008_rep_reserve c1008
          WHERE c1008.sk_agrmnt_class_val IS NOT NULL
          GROUP BY c1008.sk_agrmnt_class_val, c1008.stage_3_flag) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021008_agmt_cls_asc.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021008_agmt_cls_asc AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1042)::smallint AS agrmnt_clsfctn_id,
    src.banking_date AS agrmnt_class_start_dt,
    src.date_to AS agrmnt_class_end_dt,
    src.sk_agrmnt_class_val AS agrmnt_class_val_id,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT _src.sk_agrmnt,
            _src.banking_date,
            COALESCE((min(_src.banking_date) OVER (PARTITION BY _src.sk_agrmnt ORDER BY _src.banking_date ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS date_to,
            _src.sk_agrmnt_class_val,
            _src.sk_info_system,
            _src.sk_input_file,
            _src.action_cd
           FROM ( WITH cte AS (
                         SELECT c1008.sk_agrmnt,
                            c1008.banking_date,
                            c1008.sk_agrmnt_class_val,
                            min(c1008.sk_agrmnt_class_val) OVER (PARTITION BY c1008.sk_agrmnt ORDER BY c1008.banking_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_sk_agrmnt_class_val,
                            c1008.info_system_id AS sk_info_system,
                            c1008.input_file_id AS sk_input_file,
                            COALESCE(( SELECT 'H'::text AS text
                                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                                  WHERE b1007.contract_idt = c1008.acnt_contract_id
                                  GROUP BY 'H'::text), 'I'::text) AS action_cd,
                                CASE
                                    WHEN c1008.sk_agrmnt_class_val = (min(c1008.sk_agrmnt_class_val) OVER (PARTITION BY c1008.sk_agrmnt ORDER BY c1008.banking_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) OR (c1008.sk_agrmnt_class_val IS NULL AND (min(c1008.sk_agrmnt_class_val) OVER (PARTITION BY c1008.sk_agrmnt ORDER BY c1008.banking_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) IS NULL) THEN 0
                                    ELSE 1
                                END AS qualify_1
                           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021008_rep_reserve c1008
                          WHERE 1 = 1 AND c1008.sk_agrmnt IS NOT NULL
                        )
                 SELECT cte.sk_agrmnt,
                    cte.banking_date,
                    cte.sk_agrmnt_class_val,
                    cte.prev_sk_agrmnt_class_val,
                    cte.sk_info_system,
                    cte.sk_input_file,
                    cte.action_cd
                   FROM cte
                  WHERE cte.qualify_1 = 1) _src) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021008_agmt_mtr_hst_w4.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021008_agmt_mtr_hst_w4 AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    src.banking_date AS acct_bal_summary_start_dt,
    '9999-12-31'::date AS acct_bal_summary_end_dt,
    src.prov_ifrs9_ras AS way4_estimated_res_bal_rub,
    src.gross_carrying_amount_on_b AS way4_gross_carrying_rub,
    'N'::text::character(1) AS deleted_flag,
    src.action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c1008.sk_agrmnt,
            c1008.banking_date,
            c1008.prov_ifrs9_ras,
            c1008.gross_carrying_amount_on_b,
            c1008.info_system_id AS sk_info_system,
            c1008.input_file_id AS sk_input_file,
            COALESCE(( SELECT 'H'::text AS text
                   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000021007_contract_ids b1007
                  WHERE b1007.contract_idt = c1008.acnt_contract_id
                  GROUP BY 'H'::text), 'I'::text) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021008_rep_reserve c1008
          WHERE 1 = 1 AND c1008.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000021008_agrmnt.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000021008_agrmnt AS 
 SELECT src.sk_agrmnt AS agrmnt_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system::smallint AS info_system_id
   FROM ( SELECT c1008.input_file_name,
            c1008.info_system_type_cd,
            c1008.info_system_inst_cd,
            c1008.input_file_id,
            c1008.info_system_id,
            c1008.banking_date,
            c1008.contract_number,
            c1008.record_source,
            c1008.gross_carrying_amount_on_b,
            c1008.av_rate_on_b,
            c1008.prov_ifrs9_ras,
            c1008.stage_3_flag,
            c1008.acnt_contract_id,
            c1008.calc_rate_off_b,
            c1008.sk_agrmnt,
            c1008.sk_agrmnt_class_val,
            c1008.info_system_id AS sk_info_system,
            c1008.input_file_id AS sk_input_file
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000021008_rep_reserve c1008) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_access_device.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_access_device
AS WITH cte AS 
		(
         SELECT a.sk_access_device AS access_device_id,
            'CRD'::character(3) AS access_device_type_cd,
            a.info_system_id AS data_src_id,
            null::character(1) AS host_access_device_id,
            'N'::character(1) AS deleted_flag,
            'I'::character(1) AS action_cd,
            a.input_file_id,
            a.info_system_id,
            row_number() OVER (PARTITION BY a.sk_access_device ORDER BY a.input_file_id DESC) AS qualify_1
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr a
          WHERE a.card_numbers IS NOT NULL
        )
 SELECT cte.access_device_id,
    cte.access_device_type_cd,
    cte.data_src_id,
    cte.host_access_device_id,
    cte.deleted_flag,
    cte.action_cd,
    cte.input_file_id,
    cte.info_system_id
   FROM cte
  WHERE cte.qualify_1 = 1;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_acct_acc_dev.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033001_acct_acc_dev
AS SELECT 
	src.sk_agrmnt AS agrmnt_id,
    0::int AS acct_access_device_type_id,
    '1900-01-01'::date AS acct_access_device_start_dt,
    src.sk_access_device AS access_device_id,
    '9999-12-31'::date AS acct_access_device_end_dt,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT
			c.sk_agrmnt,
            c.sk_access_device,
            c.info_system_id,
            c.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c
          WHERE c.sk_access_device > 0
		  and 1=0  --Отключаем загрузку связки карта-договор, т.к. стали приходить некорректные номера карт и удалять правильные связи
          GROUP BY c.sk_agrmnt, c.sk_access_device, c.info_system_id, c.input_file_id
		  ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_acct_cred_limit.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_acct_cred_limit
AS SELECT 
	src.sk_agrmnt AS agrmnt_id,
    4::int AS limit_type_id,
    src.record_date_from AS cred_limit_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000039999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params
              WHERE b0160000039999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS cred_limit_end_dt,
    (( SELECT min(k_crncy_nk39.tgt_id) AS min
           FROM s_grnplm_as_t_didsd_016_db_tmd.k_crncy_nk39
          WHERE k_crncy_nk39.nk39_currency_cd = '810'::text AND k_crncy_nk39.info_system_inst_cd = '000003'::text AND k_crncy_nk39.info_system_type_cd = '016'::text))::bigint AS cred_limit_crncy_id,
    src.full_crlim::numeric(26,4) AS cred_limit_amt,
    'N'::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c3001.sk_agrmnt,
            c3001.record_date_from,
            c3001.record_date_to,
            c3001.full_crlim,
            c3001.info_system_id,
            c3001.input_file_id,
            'I'::character(1) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c3001
          WHERE c3001.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_acct_crncy.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_acct_crncy
AS SELECT src.sk_agrmnt AS agrmnt_id,
    4::integer AS crncy_use_id,
    '1900-01-01'::date AS acct_crncy_start_dt,
    '9999-12-31'::date AS acct_crncy_end_dt,
    src.sk_currency AS acct_crncy_id,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000033001_attr.sk_agrmnt,
            c0160000033001_attr.sk_currency,
            c0160000033001_attr.info_system_id,
            c0160000033001_attr.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr
          WHERE c0160000033001_attr.sk_agrmnt IS NOT NULL
		  ) src
  GROUP BY src.sk_agrmnt, 4::integer, '1900-01-01'::date, '9999-12-31'::date, src.sk_currency, 'N'::text::character(1), 'I'::character(1), src.input_file_id, src.info_system_id;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_acct_rate.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_acct_rate
AS 
SELECT src.sk_agrmnt AS agrmnt_id,
    1::int AS rate_type_id,
    2::int AS bal_cat_type_id,
    src.record_date_from AS acct_rate_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000039999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params
              WHERE b0160000039999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS acct_rate_end_dt,
        CASE
            WHEN (src.ln_int_rate >= (-999.999999999999) AND src.ln_int_rate <= 999.999999999999) OR src.ln_int_rate IS NULL THEN src.ln_int_rate
            ELSE (-999.999999999999)
        END::numeric(15,12) AS acct_rate,
    6::int AS acct_rate_time_period_id,
    -1::int AS intrst_calc_type_id,
    -1::int AS term_compliance_type_id,
    'N'::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c3001.sk_agrmnt,
            c3001.record_date_from,
            c3001.record_date_to,
            c3001.ln_int_rate,
            c3001.info_system_id,
            c3001.input_file_id,
            'I'::character(1) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c3001
          WHERE c3001.sk_agrmnt IS NOT NULL) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agmt_cls_asc.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agmt_cls_asc
AS SELECT src.sk_agrmnt AS agrmnt_id,
    (-1028)::int AS agrmnt_clsfctn_id,
    src.record_date_from AS agrmnt_class_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000039999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params
              WHERE b0160000039999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_class_end_dt,
    COALESCE(src.sk_agrmnt_cls_val_early_ovd, (-1)::bigint) AS agrmnt_class_val_id,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c3001.sk_agrmnt,
            c3001.record_date_from,
            c3001.record_date_to,
            c3001.sk_agrmnt_cls_val_early_ovd,
            c3001.info_system_id,
            c3001.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c3001
          WHERE c3001.sk_agrmnt IS NOT NULL
		  ) src
UNION ALL
 SELECT src.sk_agrmnt AS agrmnt_id,
    (-1029)::int AS agrmnt_clsfctn_id,
    src.record_date_from AS agrmnt_class_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000039999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params
              WHERE b0160000039999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_class_end_dt,
    COALESCE(src.sk_agrmnt_cls_val, (-1)::bigint) AS agrmnt_class_val_id,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c3001.sk_agrmnt,
            c3001.record_date_from,
            c3001.record_date_to,
            c3001.sk_agrmnt_cls_val,
            c3001.info_system_id,
            c3001.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c3001
          WHERE c3001.sk_agrmnt IS NOT NULL
		  ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agmt_cls_val.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agmt_cls_val
AS SELECT 
	src.sk_agrmnt_cls_val_early_ovd AS agrmnt_class_val_id,
    (-1028)::int AS agrmnt_clsfctn_id,
    src.early_ovd::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::int AS prnt_agmt_class_val_id,
    NULL::int AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000033001_attr.sk_agrmnt_cls_val_early_ovd,
            c0160000033001_attr.early_ovd,
            c0160000033001_attr.info_system_id,
            min(c0160000033001_attr.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr
          WHERE c0160000033001_attr.sk_agrmnt_cls_val_early_ovd IS NOT NULL
          GROUP BY c0160000033001_attr.sk_agrmnt_cls_val_early_ovd, c0160000033001_attr.early_ovd, c0160000033001_attr.info_system_id
		  ) src
UNION ALL
 SELECT src.sk_agrmnt_cls_val AS agrmnt_class_val_id,
    (-1029)::int AS agrmnt_clsfctn_id,
    src.credit_attr::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::int AS prnt_agmt_class_val_id,
    NULL::int AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c0160000033001_attr.sk_agrmnt_cls_val,
            c0160000033001_attr.credit_attr,
            c0160000033001_attr.info_system_id,
            min(c0160000033001_attr.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr
          WHERE c0160000033001_attr.sk_agrmnt_cls_val IS NOT NULL
          GROUP BY c0160000033001_attr.sk_agrmnt_cls_val, c0160000033001_attr.credit_attr, c0160000033001_attr.info_system_id
		  ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agrmnt.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agrmnt
AS 
SELECT DISTINCT 
	src.sk_agrmnt AS agrmnt_id,
	CASE WHEN src._3001_contract_idt IS NULL THEN src.contract_expiration_dt
	ELSE src.acnt_date_expire END AS contract_expiration_dt,
	CASE
		CASE WHEN src._3002_contract_idt IS NULL THEN src.status_id
		ELSE src._3002_status_id::bigint END
	WHEN 51::integer THEN 10::integer
	ELSE 9::integer
	END::integer AS acct_current_stts_type_id,
    src.crlim_date_open AS way4_f9_crlim_dt,
    'Y'::character(1) AS way4_f9_flag,
	case when _3001B_contract_idt is null then t.acct_open_dt else src.agreement_open_date end AS acct_open_dt,
    ( SELECT max(kis.tgt_id) AS max FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system kis WHERE kis.nk01_info_system_type_cd = '016'::text AND kis.nk01_info_system_inst_cd = '000003'::text) AS acct_src_id,
    NULL::date AS acct_close_dt,
    NULL::date AS acct_signed_dt,
	UPPER(case when _3001B_contract_idt is null then t.agrmnt_num else src.agreement_number end) as agrmnt_num,
    COALESCE(src.contract_idt, src.agreement_id_w4)::character varying(255) AS host_agrmnt_cd,
    NULL::character varying(255) AS host_agrmnt_guid,
    1::integer AS agrmnt_categ_id,
    '1900-01-01'::date AS agrmnt_rec_start_dt,
    '9999-12-31'::date AS agrmnt_rec_end_dt,
    NULL::character(1) AS bki_grant_flag,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.sk_input_file AS input_file_id,
    src.sk_info_system AS info_system_id
   FROM ( 
		SELECT 
			_src.sk_agrmnt,
            _src._3001_contract_idt,
            _src._3002_contract_idt,
			cc3001.contract_idt as _3001B_contract_idt,
            _src.contract_idt,
            _src.acnt_date_expire,
            _src.crlim_date_open,
            COALESCE(t_acct_stts_type.acct_stts_type_id, CASE WHEN _src.acnt_status IS NULL THEN (-1) ELSE (-999) END) AS _3002_status_id,
            ( SELECT max(ki.tgt_id) AS max FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system ki WHERE ki.nk01_info_system_type_cd = '016'::text AND ki.nk01_info_system_inst_cd = '000003'::text) AS sk_info_system,
			cc3001.contract_number::character varying(255) AS agreement_number,
            NULL::bigint AS agreement_id_w4,
            cc3001.acnt_date_open AS agreement_open_date,
            NULL::bigint AS status_id,
            _src.acnt_date_expire AS contract_expiration_dt,
            _src.input_file_id AS sk_input_file
           FROM ( SELECT _sk_agrmnt.tgt_id AS sk_agrmnt,
                    COALESCE(c3001.contract_idt, c3002.contract_idt) AS contract_idt,
                    c3001.contract_idt AS _3001_contract_idt,
                    c3002.contract_idt AS _3002_contract_idt,
                    c3001.acnt_date_expire,
                    c3001.crlim_date_open,
                    c3002.acnt_status,
                    COALESCE(c3001.input_file_id, c3002.input_file_id) AS input_file_id
                   FROM ( SELECT l016_3001_attr.contract_idt,
                            l016_3001_attr.record_date_to,
                            l016_3001_attr.record_date_from,
                            l016_3001_attr.acnt_date_expire,
                            l016_3001_attr.crlim_date_open,
                            l016_3001_attr.dl,
                            l016_3001_attr.client_idt,
                            l016_3001_attr.input_file_id
                           FROM s_grnplm_as_t_didsd_016_db_stg.l016_3001_attr
                          WHERE l016_3001_attr.record_date_to = '9999-12-31'::date
						  ) c3001
                     FULL JOIN ( SELECT l016_3002_ext_attr.contract_idt,
                            l016_3002_ext_attr.record_date_to,
                            l016_3002_ext_attr.record_date_from,
                            l016_3002_ext_attr.contr_status,
                            l016_3002_ext_attr.card_status,
                            l016_3002_ext_attr.acnt_status,
                            l016_3002_ext_attr.status_category,
                            l016_3002_ext_attr.input_file_id
                           FROM s_grnplm_as_t_didsd_016_db_stg.l016_3002_ext_attr
                          WHERE l016_3002_ext_attr.record_date_to = '9999-12-31'::date
						  ) c3002 
					 ON c3002.contract_idt = c3001.contract_idt
                     LEFT JOIN ( SELECT k_agrmnt_nk76.tgt_id,
                                 k_agrmnt_nk76.nk76_agreement_id_f9
                                 FROM s_grnplm_as_t_didsd_016_db_tmd.k_agrmnt_nk76
                                 WHERE k_agrmnt_nk76.info_system_inst_cd = '000003'::text 
								 AND k_agrmnt_nk76.info_system_type_cd = '016'::text 
								 AND k_agrmnt_nk76.nk76_agreement_id_f9 IS NOT NULL
								 ) _sk_agrmnt 
						   ON _sk_agrmnt.nk76_agreement_id_f9 = COALESCE(c3001.contract_idt, c3002.contract_idt)
				   ) _src
             LEFT JOIN S_GRNPLM_AS_T_DIDSD_016_DB_STG.C0160000033001_ATTR cc3001 
					ON cc3001.contract_idt = _src.contract_idt
             LEFT JOIN S_GRNPLM_AS_T_DIDSD_016_DB_STG.T_ACCT_STTS_TYPE t_acct_stts_type 
					ON _src.acnt_status = t_acct_stts_type.acct_stts_type_cd 
					   AND t_acct_stts_type.acct_stts_role_id = 1
			 ) src
  LEFT JOIN S_GRNPLM_AS_T_DIDSD_016_DB_STG.T_AGRMNT t on t.agrmnt_id=src.sk_agrmnt and t.info_system_id=src.sk_info_system and t.deleted_flag='N'::text
  WHERE src.sk_agrmnt IS NOT NULL; 
"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agrmnt_pty.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agrmnt_pty
AS 
SELECT 
src.sk_party AS pty_id,
src.sk_agrmnt AS agrmnt_id,
1::int AS agrmnt_pty_role_id,
'1900-01-01'::date AS agrmnt_pty_start_dt,
'9999-12-31'::date AS agrmnt_pty_end_dt,
'N'::character(1) AS deleted_flag,
'I'::character(1) AS action_cd,
src.input_file_id,
src.info_system_id
FROM ( SELECT c0160000033001_attr.sk_party,
		c0160000033001_attr.sk_agrmnt,
		c0160000033001_attr.info_system_id,
		c0160000033001_attr.input_file_id
	   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr
	  WHERE c0160000033001_attr.sk_party > 0
	  GROUP BY c0160000033001_attr.sk_party, c0160000033001_attr.sk_agrmnt, c0160000033001_attr.info_system_id, c0160000033001_attr.input_file_id
	  ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agrmnt_to_coa.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agrmnt_to_coa
AS 
SELECT 
	src.sk_agrmnt AS agrmnt_id,
    src.sk_coa AS coa_id,
    src.record_date_from AS agrmnt_gl_acct_start_dt,
    src.coa_to_agrmnt_role_id,
	CASE
		WHEN 'A'::text = (( SELECT max(b0160000039999_params.paramvalue) AS max
		   FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params
		  WHERE b0160000039999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
		WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
		ELSE src.record_date_to
	END AS agrmnt_gl_acct_end_dt,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT 
			c1.sk_agrmnt,
			CASE
				WHEN c1.loan_number IS NULL OR c1.acnt_date_open IS NULL THEN (-1)::bigint
				ELSE c1.sk_coa
			END AS sk_coa,
            c1.record_date_from,
            (-1018)::bigint AS coa_to_agrmnt_role_id,
            c1.record_date_to,
            c1.info_system_id,
            c1.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c1
          WHERE c1.sk_agrmnt IS NOT NULL
        UNION
         SELECT 
			c2.sk_agrmnt,
			CASE
				WHEN c2.deposit_number IS NULL THEN (-1)::bigint
				ELSE c2.sk_coa_dep_num
			END AS sk_coa,
            c2.record_date_from,
            (-1034)::bigint AS coa_to_agrmnt_role_id,
            c2.record_date_to,
            c2.info_system_id,
            c2.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c2
          WHERE c2.sk_agrmnt IS NOT NULL
        UNION
         SELECT 
			c3.sk_agrmnt,
            c3.sk_coa_disp_num AS sk_coa,
            c3.record_date_from,
            (-1035)::bigint AS coa_to_agrmnt_role_id,
            c3.record_date_to,
            c3.info_system_id,
            c3.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c3
          WHERE c3.sk_agrmnt IS NOT NULL AND c3.sk_coa_disp_num <> (-1)::bigint
        UNION
         SELECT 
			c4.sk_agrmnt,
            c4.sk_coa_fee_serv_num AS sk_coa,
            c4.record_date_from,
            (-1036)::bigint AS coa_to_agrmnt_role_id,
            c4.record_date_to,
            c4.info_system_id,
            c4.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c4
          WHERE c4.sk_agrmnt IS NOT NULL AND c4.sk_coa_fee_serv_num <> (-1)::bigint
        UNION
         SELECT 
			c5.sk_agrmnt,
            c5.sk_coa_ovd_num AS sk_coa,
            c5.record_date_from,
            (-1037)::bigint AS coa_to_agrmnt_role_id,
            c5.record_date_to,
            c5.info_system_id,
            c5.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c5
          WHERE c5.sk_agrmnt IS NOT NULL AND c5.sk_coa_ovd_num <> (-1)::bigint
        UNION
         SELECT 
			c6.sk_agrmnt,
            c6.sk_coa_ovdpcnt_num AS sk_coa,
            c6.record_date_from,
            (-1038)::bigint AS coa_to_agrmnt_role_id,
            c6.record_date_to,
            c6.info_system_id,
            c6.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c6
          WHERE c6.sk_agrmnt IS NOT NULL AND c6.sk_coa_ovdpcnt_num <> (-1)::bigint
        UNION
         SELECT 
			c7.sk_agrmnt,
            c7.sk_coa_ovl_num AS sk_coa,
            c7.record_date_from,
            (-1039)::bigint AS coa_to_agrmnt_role_id,
            c7.record_date_to,
            c7.info_system_id,
            c7.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c7
          WHERE c7.sk_agrmnt IS NOT NULL AND c7.sk_coa_ovl_num <> (-1)::bigint
        UNION
         SELECT 
			c8.sk_agrmnt,
			CASE
				WHEN c8.pcnt_number_bal IS NULL THEN (-1)::bigint
				ELSE c8.sk_coa_pcnt_num
			END AS sk_coa,
            c8.record_date_from,
            (-1040)::bigint AS coa_to_agrmnt_role_id,
            c8.record_date_to,
            c8.info_system_id,
            c8.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c8
          WHERE c8.sk_agrmnt IS NOT NULL
        UNION
         SELECT 
			c9.sk_agrmnt,
			CASE
				WHEN c9.pd_number IS NULL THEN (-1)::bigint
				ELSE c9.sk_coa_pd_num
			END AS sk_coa,
            c9.record_date_from,
            (-1041)::bigint AS coa_to_agrmnt_role_id,
            c9.record_date_to,
            c9.info_system_id,
            c9.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c9
          WHERE c9.sk_agrmnt IS NOT NULL
        UNION
         SELECT 
			c10.sk_agrmnt,
            c10.sk_coa_uns_num AS sk_coa,
            c10.record_date_from,
            (-1042)::bigint AS coa_to_agrmnt_role_id,
            c10.record_date_to,
            c10.info_system_id,
            c10.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c10
          WHERE c10.sk_agrmnt IS NOT NULL AND c10.sk_coa_uns_num <> (-1)::bigint
		  ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agr_text_hist.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_agr_text_hist
AS SELECT src.sk_agrmnt AS agrmnt_id,
    (-1006)::int AS agrmnt_text_type_id,
    src.record_date_from AS agrmnt_text_start_dt,
        CASE
            WHEN 'A'::text = (( SELECT max(b0160000039999_params.paramvalue) AS max
               FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params
              WHERE b0160000039999_params.paramname = 'TYPE'::text)) THEN '9999-12-31'::date
            WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
            ELSE src.record_date_to
        END AS agrmnt_text_end_dt,
    src.etsm_id::character varying(4000) AS agrmnt_txt,
    'N'::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c3001.sk_agrmnt,
            c3001.record_date_from,
            c3001.record_date_to,
            c3001.etsm_id,
            c3001.info_system_id,
            c3001.input_file_id,
            'I'::character(1) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr c3001
		   ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_coa.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033001_coa
AS 
WITH cte_1 
AS (
	SELECT 
		t.sk_coa AS coa_id,
		substring(t.loan_number, 1, 50)::character varying(50) AS coa_num,
		t.acnt_date_open AS coa_start_dt,
		t.input_file_id,
		t.info_system_id,
	row_number() OVER (PARTITION BY t.sk_coa ORDER BY t.record_date_to DESC) AS qualify_1
	FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr t
	WHERE t.sk_coa IS NOT NULL AND t.loan_number IS NOT NULL AND t.acnt_date_open IS NOT NULL
	union all
	select distinct
		sub.coa_id,
		substring(sub.coa_num, 1, 50)::character varying(50) as coa_num,
		NULL::date AS coa_start_dt,
		sub.input_file_id,
		sub.info_system_id,
		row_number() OVER (PARTITION BY sub.sk_coa, sub.coa_num ORDER BY sub.record_date_to DESC) AS qualify_1
	 from
		(
		select
		  t.sk_coa,
		  t.record_date_to,
		  t.input_file_id,
		  t.info_system_id,
		  unnest(array[sk_coa_pcnt_num,sk_coa_pd_num,sk_coa_uns_num,sk_coa_disp_num,sk_coa_dep_num,sk_coa_fee_serv_num,sk_coa_ovd_num,sk_coa_ovdpcnt_num,sk_coa_ovl_num ]) as coa_id,
		  unnest(array[pcnt_number_bal,pd_number,unused_number,disput_number,deposit_number,fee_serv_number,ovd_number,ovdpcnt_number_bal,ovl_number ]) as coa_num
		FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr t
		) sub
	where sub.coa_num is not null
	)
	
select 
	cte_1.coa_id,
    cte_1.coa_num,
    NULL::character varying(512) AS coa_name,
    cte_1.coa_start_dt,
	NULL::date AS coa_end_dt,
	NULL::character(3) AS summary_coa_ind,
	NULL::character varying(50) AS coa_src_id,
	NULL::integer AS crncy_id,
	NULL::bigint AS gl_main_acct_id,
	NULL::integer AS pl_rpt_cd_id,
	NULL::bigint AS gl_int_org_pty_id,
	'N'::character(1) AS deleted_flag,
	'I'::character(1) AS action_cd,
    cte_1.input_file_id,
    cte_1.info_system_id
from cte_1
WHERE cte_1.qualify_1 = 1;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_fin_instintorg.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_fin_instintorg
AS 
SELECT 
	src.int_org_pty_id,
    src.org_num,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
FROM ( SELECT 
		b.sk_pty AS int_org_pty_id,
		substring(b.cb_code, 1, 2)::character varying(2) AS org_num,
		( SELECT max(k_info_system.tgt_id) AS max
		  FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
		  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text
		 ) AS info_system_id,
		 b.input_file_id
		FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
		WHERE b.cb_code IS NOT NULL
        UNION ALL
        SELECT 
		b.sk_pty_osb AS int_org_pty_id,
		substring(b.cb_code, 5)::character varying(5) AS org_num,
		( SELECT max(k_info_system.tgt_id) AS max
		FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
		WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text
		) AS info_system_id,
		b.input_file_id
		FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
		WHERE b.cb_code IS NOT NULL
		) src
GROUP BY src.int_org_pty_id, src.org_num, 'N'::text::character(1), 'I'::character(1), src.input_file_id, src.info_system_id;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_fin_instintorg2.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_fin_instintorg2
AS
SELECT distinct
   src.INT_ORG_PTY_ID
 , src.ORG_NUM
 , 'N'::character(1) AS deleted_flag
 , 'I'::character(1) AS action_cd
 , src.input_file_id
 , src.info_system_id
FROM 
 (
 SELECT
   coalesce(_SK_PTY.TGT_ID,-999::bigint) as INT_ORG_PTY_ID
 , substring(b.VSP_FULL_NUMBER,7)::character varying(5) as ORG_NUM
 , (SELECT Max(tgt_id) FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system WHERE nk01_info_system_type_cd = '016'::text AND nk01_info_system_inst_cd = '000003'::text) AS info_system_id
 , b.input_file_id AS input_file_id
 FROM s_grnplm_as_t_didsd_016_db_stg.V_B0160000033001_ATTR_ADD B
 LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.K_PTY_NK226 as _SK_PTY
   ON _SK_PTY.INFO_SYSTEM_INST_CD = '000003'::text
   AND _SK_PTY.INFO_SYSTEM_TYPE_CD='016'::text
   AND _SK_PTY.NK226_VSP_FULL_NUMBER IS NOT NULL  
   AND _SK_PTY.NK226_VSP_FULL_NUMBER = B.VSP_FULL_NUMBER
 where B.VSP_FULL_NUMBER is not null   
 ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_int_org.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033001_int_org
AS SELECT src.int_org_pty_id,
    src.int_org_type_id,
    '1'::character(1) AS int_org_categ_cd,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT 
			b.sk_pty AS int_org_pty_id,
            1::int AS int_org_type_id,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            b.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
          WHERE b.cb_code IS NOT NULL
          UNION ALL
          SELECT b.sk_pty_osb AS int_org_pty_id,
            2::int AS int_org_type_id,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            b.input_file_id
          FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
          WHERE b.cb_code IS NOT NULL) src
  GROUP BY src.int_org_pty_id, src.int_org_type_id, '1'::character(1), 'N'::character(1), 'I'::character(1), src.input_file_id, src.info_system_id;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_int_org_vsp.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_int_org_vsp
AS

SELECT distinct
   INT_ORG_PTY_ID
 , 3 ::integer AS INT_ORG_TYPE_ID
 , '1'::character(1) as INT_ORG_CATEG_CD
 , 'N'::character(1) AS deleted_flag
 , 'I'::character(1) AS action_cd
 , input_file_id
 , info_system_id
FROM 
 (
 SELECT
   coalesce(_SK_PTY.TGT_ID,-999) as INT_ORG_PTY_ID
 , (SELECT Max(tgt_id) FROM s_grnplm_as_t_didsd_db_tmd.k_info_system WHERE nk01_info_system_type_cd = '016'::text AND nk01_info_system_inst_cd = '000003'::text) AS info_system_id
 , b.input_file_id AS input_file_id
 FROM s_grnplm_as_t_didsd_016_db_stg.V_B0160000033001_ATTR_ADD B
 LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.K_PTY_NK226 as _SK_PTY
   ON _SK_PTY.INFO_SYSTEM_INST_CD = '000003'::text
   AND _SK_PTY.INFO_SYSTEM_TYPE_CD='016'::text
   AND _SK_PTY.NK226_VSP_FULL_NUMBER IS NOT NULL  
   AND _SK_PTY.NK226_VSP_FULL_NUMBER = B.VSP_FULL_NUMBER
 where B.VSP_FULL_NUMBER is not null
) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_org.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_org
AS SELECT src.org_pty_id,
    src.org_type_cd,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( --ТБ
			SELECT 
			b.sk_pty AS org_pty_id,
            'INT'::character(3) AS org_type_cd,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            b.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
           WHERE b.cb_code IS NOT NULL
		   UNION ALL
		  --ВСП
		  SELECT 
			b.sk_pty_osb AS org_pty_id,
            'INT'::character(3) AS org_type_cd,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            b.input_file_id
          FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
          WHERE b.cb_code IS NOT NULL
		  ) src
GROUP BY src.org_pty_id, src.org_type_cd, 'N'::character(1), 'I'::character(1), src.input_file_id, src.info_system_id;
"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_org_lvl.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_org_lvl
AS SELECT 
	src.org_pty_id,
    6::int AS pty_struct_type_id,
    src.org_lvl_id,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT --ТБ
			b.sk_pty AS org_pty_id,
            2::smallint AS org_lvl_id,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            b.input_file_id
          FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
          WHERE b.cb_code IS NOT NULL
          UNION ALL
          SELECT  --ВСП
			b.sk_pty_osb AS org_pty_id,
            3::smallint AS org_lvl_id,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            b.input_file_id
          FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
          WHERE b.cb_code IS NOT NULL
		  ) src
  GROUP BY src.org_pty_id, 6::int, src.org_lvl_id, 'N'::character(1), 'I'::character(1), src.input_file_id, src.info_system_id;
"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_org_lvl_vsp.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_org_lvl_vsp
AS
SELECT distinct
   ORG_PTY_ID
 , 6::int as PTY_STRUCT_TYPE_ID 
 , 4::int AS ORG_LVL_ID
 , 'N'::character(1) AS deleted_flag
 , 'I'::character(1) AS action_cd
 , input_file_id
 , info_system_id
FROM 
 (
 SELECT
   coalesce(_SK_PTY.TGT_ID,-999::bigint) as ORG_PTY_ID
 , (SELECT Max(tgt_id) FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system WHERE nk01_info_system_type_cd = '016'::text AND nk01_info_system_inst_cd = '000003'::text) AS info_system_id
 , b.input_file_id AS input_file_id
 FROM s_grnplm_as_t_didsd_016_db_stg.V_B0160000033001_ATTR_ADD B
 LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.K_PTY_NK226 as _SK_PTY
   ON _SK_PTY.INFO_SYSTEM_INST_CD = '000003'::text
   AND _SK_PTY.INFO_SYSTEM_TYPE_CD='016'::text 
   AND _SK_PTY.NK226_VSP_FULL_NUMBER IS NOT NULL  
   AND _SK_PTY.NK226_VSP_FULL_NUMBER = B.VSP_FULL_NUMBER
 where B.VSP_FULL_NUMBER is not null
 ) src;
"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_org_vsp.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_org_vsp
AS
SELECT distinct
   ORG_PTY_ID
 , ORG_TYPE_CD
 , 'N'::character(1) AS deleted_flag
 , 'I'::character(1) AS action_cd
 , input_file_id
 , info_system_id
FROM 
 (
 SELECT
   coalesce(_SK_PTY.TGT_ID,-999::bigint) as ORG_PTY_ID
 , 'INT'::character(3) as ORG_TYPE_CD
 , (SELECT Max(tgt_id) FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system WHERE nk01_info_system_type_cd = '016'::text AND nk01_info_system_inst_cd = '000003'::text) AS info_system_id
 , b.input_file_id AS input_file_id
 FROM s_grnplm_as_t_didsd_016_db_stg.V_B0160000033001_ATTR_ADD B
 LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.K_PTY_NK226 as _SK_PTY
   ON _SK_PTY.INFO_SYSTEM_INST_CD = '000003'::text
   AND _SK_PTY.INFO_SYSTEM_TYPE_CD='016'::text
   AND _SK_PTY.NK226_VSP_FULL_NUMBER IS NOT NULL  
   AND _SK_PTY.NK226_VSP_FULL_NUMBER = B.VSP_FULL_NUMBER
 where B.VSP_FULL_NUMBER is not null
) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_pty.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_pty
AS SELECT 
	src.pty_id,
    src.pty_type_cd,
    src.info_system_id AS pty_src_id,
    src.src_pty_cd,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT  --ТБ
			b.sk_pty AS pty_id,
            'ORG'::character(3) AS pty_type_cd,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            substring(b.cb_code, 5)::character varying(5) AS src_pty_cd,
            b.input_file_id
          FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
          WHERE b.cb_code IS NOT NULL
          UNION ALL
          SELECT --ВСП
			b.sk_pty_osb AS pty_id,
            'ORG'::character(3) AS pty_type_cd,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            substring(b.cb_code, 1, 2)::character varying(2) AS src_pty_cd,
            b.input_file_id
          FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
          WHERE b.cb_code IS NOT NULL
		  ) src
GROUP BY src.pty_id, src.pty_type_cd, src.info_system_id, src.src_pty_cd, 'N'::character(1), 'I'::character(1), src.input_file_id;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_pty_access_dev.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033001_pty_access_dev
AS WITH sub1 
as (
	select 
		l.CONTRACT_IDT                  
	  , l.RECORD_DATE_FROM                
      , l.DL
      , l.INPUT_FILE_ID
	  , case when strpos(l.dl,'0'::text)=1::int then substr(l.dl,2) else l.dl end as dl_s
	from s_grnplm_as_t_didsd_016_db_stg.l016_3001_attr l
	),
cte AS (
         SELECT _b.osb_id,
            _b.tb_number,
            _b.tb_old_number,
            _b.osb_number,
            _b.osb_name,
            _b.info_system_type_cd,
            _b.info_system_inst_cd,
            _b.input_file_name,
            _b.input_file_id,
            _b.info_system_id,
            _b.workflow_run_id,
            _b.current_load_flag,
			lag(substring(_b.input_file_name,12,8)::date-1) over(partition by _b.osb_id order by _b.input_file_name) AS actual_from_x,
			lead(substring(_b.input_file_name,12,8)::date-1) over(partition by _b.osb_id order by _b.input_file_name) AS actual_to_x
           FROM s_grnplm_as_t_didsd_016_db_stg.s016_0001_branch _b
        )

 SELECT 
	COALESCE(_sk_pty.tgt_id, (-999)::bigint) AS pty_id,
    a.sk_access_device AS access_device_id,
    1::int AS pty_access_device_role_id,
    s.record_date_from AS pty_access_device_start_dt,
    s.record_date_to AS pty_access_device_end_dt,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    a.input_file_id,
    ( SELECT max(k_info_system.tgt_id) AS max
           FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
          WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id
   FROM ( SELECT _s3001.contract_idt,
				_s3001.record_date_from,
				_s3001.dl,
				_s3001.prev_dl,
				_s3001.is_eq,
				_s3001.input_file_id,
				LEAD(_s3001.record_date_from - 1,1,'9999-12-31'::date) OVER(PARTITION BY _s3001.contract_idt ORDER BY _s3001.record_date_from) as record_date_to,
                CASE WHEN _b.tb_number IS NOT NULL THEN (_b.tb_number||substr(_s3001.dl::text,3))::character varying
                     ELSE _s3001.dl
                END::character varying(32) AS vsp_full_number
           FROM ( SELECT 
					_t.contract_idt,
                    _t.record_date_from,
                    _t.dl,
                    max(_t.dl::text) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_dl,
                        CASE
                            WHEN _t.dl::text = (max(_t.dl::text) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) THEN 1::int
                            ELSE 0::int
                        END AS is_eq,
                    _t.input_file_id
                   FROM ( SELECT 
							s1.contract_idt,
							s1.record_date_from,
                            CASE WHEN substr(s1.dl_s,7,1) = '0'::text THEN substr(s1.dl_s,1,6)||substr(s1.dl_s,8)
                                 ELSE s1.dl_s
                            END::character varying(32) AS dl,
                            s1.input_file_id
                           FROM sub1 as s1) _t
				 ) _s3001
             LEFT JOIN ( SELECT _b_1.osb_id,
								_b_1.tb_number,
								_b_1.tb_old_number,
								_b_1.osb_number,
								_b_1.osb_name,
								_b_1.info_system_type_cd,
								_b_1.info_system_inst_cd,
								_b_1.input_file_name,
								_b_1.input_file_id,
								_b_1.info_system_id,
								_b_1.workflow_run_id,
								_b_1.current_load_flag,
								_b_1.actual_from_x,
								_b_1.actual_to_x,
							CASE WHEN _b_1.actual_from_x IS NOT NULL THEN substr(_b_1.input_file_name, 12, 8)::date
								ELSE '1900-01-01'::date
							END AS actual_from,
							COALESCE(_b_1.actual_to_x, '9999-12-31'::date) AS actual_to
						FROM cte _b_1
						) _b 
				ON substr(_s3001.dl::text,1,2) = _b.tb_old_number 
				AND substr(_s3001.dl::text,3,4) = _b.osb_number 
				AND _s3001.record_date_from >= _b.actual_from 
				AND _s3001.record_date_from <= _b.actual_to
          WHERE _s3001.is_eq = 0::int
		  ) s
     JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr a ON s.contract_idt = a.contract_idt
     LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.k_pty_nk226 _sk_pty 
			ON _sk_pty.info_system_inst_cd = '000003'::text 
			AND _sk_pty.info_system_type_cd = '016'::text 
			AND _sk_pty.nk226_vsp_full_number IS NOT NULL 
			AND _sk_pty.nk226_vsp_full_number = s.vsp_full_number::text
  WHERE s.vsp_full_number IS NOT NULL 
  AND a.card_numbers IS NOT NULL
  GROUP BY COALESCE(_sk_pty.tgt_id, (-999)::bigint), a.sk_access_device, 1::int, s.record_date_from, s.record_date_to, 'N'::character(1), 'I'::character(1), a.input_file_id, ( SELECT max(k_info_system.tgt_id) AS max
           FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
          WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text);"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_pty_ind.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_pty_ind
AS SELECT 
	src.pty_id,
    src.pty_type_cd,
    src.info_system_id AS pty_src_id,
    src.src_pty_cd,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT 
			b.sk_party AS pty_id,
            'IND'::character(3) AS pty_type_cd,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            b.client_idt::character varying(25) AS src_pty_cd,
            b.input_file_id
          FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
          WHERE b.client_idt IS NOT NULL
		 ) src
GROUP BY src.pty_id, src.pty_type_cd, src.info_system_id, src.src_pty_cd, 'N'::character(1), 'I'::character(1), src.input_file_id;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_pty_related.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_pty_related
AS SELECT 
	src.relates_pty_id,
    1::int AS pty_rel_role_id,
    src.related_pty_id,
    '1900-01-01'::date AS pty_rel_start_dt,
    '1900-01-01'::date AS pty_rel_end_dt,
    6::int AS pty_struct_type_id,
    'N'::text::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT 
			b.sk_pty AS relates_pty_id,
            b.sk_pty_osb AS related_pty_id,
            ( SELECT max(k_info_system.tgt_id) AS max FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            b.input_file_id
          FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033001_attr b
          WHERE b.cb_code IS NOT NULL
		  ) src
GROUP BY src.relates_pty_id, 1::int, src.related_pty_id, '1900-01-01'::date, 6::int, 'N'::character(1), 'I'::character(1), src.input_file_id, src.info_system_id;
  "
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033001_pty_vsp.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033001_pty_vsp
AS
SELECT distinct
   pty_id
 , pty_type_cd
 , info_system_id as pty_src_id
 , src_pty_cd
 , 'N'::character(1) AS deleted_flag
 , 'I'::character(1) AS action_cd
 , input_file_id
 , info_system_id
FROM 
 (
 SELECT
   coalesce(_SK_PTY.TGT_ID,(-999)::bigint) as PTY_ID
 , 'ORG'::character(3) as PTY_TYPE_CD
 , (SELECT Max(tgt_id) FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system WHERE nk01_info_system_type_cd = '016'::text AND nk01_info_system_inst_cd = '000003'::text) AS info_system_id
 , b.VSP_FULL_NUMBER as SRC_PTY_CD
 , b.input_file_id AS input_file_id
 FROM s_grnplm_as_t_didsd_016_db_stg.V_B0160000033001_ATTR_ADD B
 LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.K_PTY_NK226 as _SK_PTY
   ON _SK_PTY.INFO_SYSTEM_INST_CD = '000003'::text
   AND _SK_PTY.INFO_SYSTEM_TYPE_CD='016'::text
   AND _SK_PTY.NK226_VSP_FULL_NUMBER IS NOT NULL
   AND _SK_PTY.NK226_VSP_FULL_NUMBER = B.VSP_FULL_NUMBER
 where B.VSP_FULL_NUMBER is not null
 ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033002_acct_stts_hist.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033002_acct_stts_hist
AS SELECT 
	src.sk_agrmnt AS agrmnt_id,
    src.acct_stts_type_id,
    src.record_date_from AS acct_stts_start_dt,
    src.record_date_to AS acct_stts_end_dt,
    src.acct_stts_reason_id,
    1::bigint AS acct_stts_role_id,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT _src.sk_agrmnt,
            _src.record_date_from,
            COALESCE(_src.record_date_to, '9999-12-31'::date) AS record_date_to,
            _src.acct_stts_type_id,
            _src.acct_stts_reason_id,
            ( SELECT max(k_info_system.tgt_id) AS max
                   FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
                  WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            _src.input_file_id
           FROM ( SELECT _sk_agrmnt.tgt_id AS sk_agrmnt,
                    _s3001.record_date_from,
                    --COALESCE((min(_s3001.record_date_from) OVER (PARTITION BY _s3001.contract_idt ORDER BY _s3001.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS record_date_to,
					LEAD(_s3001.record_date_from-1,1,'9999-12-31'::date) OVER (PARTITION BY _s3001.contract_idt ORDER BY _s3001.record_date_from) as record_date_to,
                    COALESCE(_acct_tp.acct_stts_type_id, (-1)::bigint) AS acct_stts_type_id,
                    COALESCE(_acc_reason_tp.acct_stts_reason_id, (-1)::bigint) AS acct_stts_reason_id,
                    _s3001.input_file_id,
                    _s3001.contract_idt
                   FROM ( SELECT 
							_t.contract_idt,
                            _t.record_date_from,
                            _t.contr_status,
                            _t.acnt_status,
                            max(_t.contr_status) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_contr_status,
                            max(_t.acnt_status) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_acnt_status,
							CASE
								WHEN _t.contr_status = (max(_t.contr_status) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) 
									 AND COALESCE(_t.acnt_status, '-2'::text) = COALESCE(max(_t.acnt_status) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING), '-2'::text) 
								THEN 1::int
								ELSE 0::int
							END AS is_eq,
                            _t.input_file_id
                           FROM ( SELECT s3002.contract_idt,
                                    s3002.record_date_from,
                                    upper(s3002.contr_status) as contr_status,
                                    upper(s3002.acnt_status) as acnt_status,
                                    upper(s3002.status_category) as status_category,
                                    s3002.input_file_id
                                   FROM s_grnplm_as_t_didsd_016_db_stg.l016_3002_ext_attr s3002
                                     JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000033002_ext_attr c ON s3002.contract_idt = c.contract_idt
                                  WHERE s3002.contr_status IS NOT NULL AND s3002.acnt_status IS NOT NULL
                                  GROUP BY s3002.contract_idt, s3002.record_date_from, upper(s3002.contr_status), upper(s3002.acnt_status), upper(s3002.status_category), s3002.input_file_id) _t
								 ) _s3001
                     JOIN s_grnplm_as_t_didsd_016_db_tmd.k_agrmnt_nk76 _sk_agrmnt 
					   ON _sk_agrmnt.info_system_inst_cd = '000003'::text 
					   AND _sk_agrmnt.info_system_type_cd = '016'::text 
					   AND _sk_agrmnt.nk76_agreement_id_f9 IS NOT NULL 
					   AND _sk_agrmnt.nk76_agreement_id_f9 = _s3001.contract_idt
                     LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.t_acct_stts_reason_type _acc_reason_tp ON upper(_acc_reason_tp.acct_stts_reason_cd) = upper(_s3001.contr_status)
                     LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.t_acct_stts_type _acct_tp ON upper(_acct_tp.acct_stts_type_cd) = upper(_s3001.acnt_status) AND _acct_tp.acct_stts_role_id = 1::bigint
                  WHERE 1 = 1 
				  AND _s3001.is_eq = 0::int
				  AND _sk_agrmnt.tgt_id IS NOT NULL
				  ) _src
		) src
  GROUP BY src.sk_agrmnt, src.acct_stts_type_id, src.record_date_from, src.record_date_to, src.acct_stts_reason_id, 1::bigint, 'N'::character(1), 'I'::character(1), src.input_file_id, src.info_system_id;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033002_acct_stts_hist2.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033002_acct_stts_hist2
AS SELECT src.sk_agrmnt AS agrmnt_id,
    src.acct_stts_type_id,
    src.record_date_from AS acct_stts_start_dt,
    src.record_date_to AS acct_stts_end_dt,
    src.acct_stts_reason_id,
    (-1003)::bigint AS acct_stts_role_id,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT _src.sk_agrmnt,
            _src.record_date_from,
            COALESCE(_src.record_date_to, '9999-12-31'::date) AS record_date_to,
            _src.acct_stts_type_id,
            _src.acct_stts_reason_id,
            ( SELECT max(k_info_system.tgt_id) AS max
              FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system
              WHERE k_info_system.nk01_info_system_type_cd = '016'::text AND k_info_system.nk01_info_system_inst_cd = '000003'::text
			 ) AS info_system_id,
            _src.input_file_id
           FROM ( SELECT 
					_sk_agrmnt.tgt_id AS sk_agrmnt,
                    _s3001.record_date_from,
                    --COALESCE((min(_s3001.record_date_from) OVER (PARTITION BY _s3001.contract_idt ORDER BY _s3001.record_date_from ROWS BETWEEN 1 FOLLOWING AND 1 FOLLOWING)) - 1, '9999-12-31'::date) AS record_date_to,
					LEAD(_s3001.record_date_from-1,1,'9999-12-31'::date) OVER (PARTITION BY _s3001.contract_idt ORDER BY _s3001.record_date_from) as record_date_to,
                    COALESCE(_acct_tp.acct_stts_type_id, (-1)::bigint) AS acct_stts_type_id,
                    (-1)::bigint AS acct_stts_reason_id,
                    _s3001.input_file_id,
                    _s3001.contract_idt
                   FROM ( SELECT 
							_t.contract_idt,
                            _t.record_date_from,
                            _t.contr_status,
                            _t.status_category,
                            max(_t.status_category) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_status_category,
							CASE WHEN _t.status_category = (max(_t.status_category) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) 
								 THEN 1::int
								ELSE 0::int
							END AS is_eq_cat,
                            _t.input_file_id
                           FROM ( SELECT s3002.contract_idt,
                                    s3002.record_date_from,
									upper(s3002.contr_status) as contr_status,
                                    upper(s3002.acnt_status) as acnt_status,
                                    upper(s3002.status_category) as status_category,
                                    s3002.input_file_id
                                  FROM s_grnplm_as_t_didsd_016_db_stg.l016_3002_ext_attr s3002
                                     JOIN s_grnplm_as_t_didsd_016_db_stg.c0160000033002_ext_attr c ON s3002.contract_idt = c.contract_idt
                                  WHERE s3002.status_category IS NOT NULL
                                  GROUP BY s3002.contract_idt, s3002.record_date_from, upper(s3002.contr_status), upper(s3002.acnt_status), upper(s3002.status_category), s3002.input_file_id
								  ) _t
						 ) _s3001
                     JOIN s_grnplm_as_t_didsd_016_db_tmd.k_agrmnt_nk76 _sk_agrmnt 
					   ON _sk_agrmnt.info_system_inst_cd = '000003'::text 
					   AND _sk_agrmnt.info_system_type_cd = '016'::text 
					   AND _sk_agrmnt.nk76_agreement_id_f9 IS NOT NULL 
					   AND _sk_agrmnt.nk76_agreement_id_f9 = _s3001.contract_idt
                     LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.t_acct_stts_type _acct_tp ON upper(_acct_tp.acct_stts_type_cd) = upper(_s3001.status_category) AND _acct_tp.acct_stts_role_id = (-1003)::bigint
                  WHERE 1 = 1 
				  AND _s3001.is_eq_cat = 0::int
				  AND _sk_agrmnt.tgt_id IS NOT NULL
				  ) _src
		) src
  GROUP BY src.sk_agrmnt, src.acct_stts_type_id, src.record_date_from, src.record_date_to, src.acct_stts_reason_id, (-1003)::integer, 'N'::character(1), 'I'::character(1), src.input_file_id, src.info_system_id;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033003_acct_cred_limit.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033003_acct_cred_limit
AS SELECT 
	src.sk_agrmnt AS agrmnt_id,
    2::int AS limit_type_id,
    src.record_date_from AS cred_limit_start_dt,
	CASE WHEN 'A'::text = (( SELECT upper(max(p.paramvalue)) AS max FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params p WHERE upper(p.paramname) = 'TYPE'::text)) 
		 THEN '9999-12-31'::date
		 WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
	ELSE src.record_date_to
	END AS cred_limit_end_dt,
    COALESCE(( SELECT min(k_crncy_nk39.tgt_id) AS min FROM s_grnplm_as_t_didsd_016_db_tmd.k_crncy_nk39 WHERE k_crncy_nk39.nk39_currency_cd = '810'::text AND k_crncy_nk39.info_system_inst_cd = '000003'::text AND k_crncy_nk39.info_system_type_cd = '016'::text), (-1)::bigint)::bigint AS cred_limit_crncy_id,
    src.unused_crlim::numeric(26,4) AS cred_limit_amt,
    'N'::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c3003.sk_agrmnt,
            c3003.record_date_from,
            c3003.record_date_to,
            c3003.unused_crlim,
            c3003.info_system_id,
            c3003.input_file_id,
            'I'::character(1) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033003_debt_fin_stat c3003
          WHERE c3003.sk_agrmnt IS NOT NULL
		  ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033003_acct_pymnt_opt.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033003_acct_pymnt_opt
AS SELECT 
	src.sk_pymnt_option AS acct_pymnt_option_id,
    src.sk_agrmnt AS agrmnt_id,
    1::int AS pymnt_option_id,
    src.record_date_from AS acct_pymnt_option_start_dt,
    NULL::bigint AS pymnt_cat_id,
    src.pd_date AS acct_pymnt_due_dt,
	CASE WHEN 'A'::text = (( SELECT upper(max(p.paramvalue)) AS max FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params p WHERE upper(p.paramname) = 'TYPE'::text)) THEN '9999-12-31'::date
		 WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
	ELSE src.record_date_to
	END AS acct_pymnt_option_end_dt,
    src.pd_amount::numeric(26,4) AS acct_pymnt_option_amt,
    NULL::date AS loan_availability_end_dt,
    NULL::integer AS acct_pymnt_nbr,
    NULL::date AS acct_pymnt_option_amt_start_dt,
    NULL::date AS acct_pymnt_option_amt_end_dt,
    NULL::integer AS acct_pymnt_option_amt_crncy_id,
    'N'::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c3003.sk_pymnt_option,
            c3003.sk_agrmnt,
            c3003.record_date_from,
            c3003.pd_date,
            c3003.record_date_to,
            c3003.pd_amount,
            c3003.info_system_id,
            c3003.input_file_id,
            'I'::character(1) AS action_cd
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033003_debt_fin_stat c3003
          WHERE c3003.sk_agrmnt IS NOT NULL AND c3003.sk_pymnt_option IS NOT NULL
		 ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033005_acct_acct_grp.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033005_acct_acct_grp
AS SELECT 
	src.sk_agrmnt AS agrmnt_id,
    COALESCE(src.sk_acct_grp, (-1)::bigint) AS acct_grp_id,
    src.record_date_from AS acct_assoc_start_dt,
	CASE WHEN 'A'::text = (SELECT upper(max(p.paramvalue)) AS max FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params p WHERE upper(p.paramname) = 'TYPE'::text) THEN '9999-12-31'::date
		WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
		ELSE src.record_date_to
	END AS acct_assoc_end_dt,
    'N'::character(1) AS deleted_flag,
    src.action_cd,
    src.input_file_id,
    src.info_system_id
   FROM 
	  ( SELECT 
		c3005.sk_agrmnt,
		c3005.sk_acct_grp,
		c3005.record_date_from,
		c3005.record_date_to,
		c3005.info_system_id,
		c3005.input_file_id,
		'I'::character(1) AS action_cd
        FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033005_res_wroff c3005
        WHERE c3005.sk_agrmnt IS NOT NULL
	  ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033005_acct_grp.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033005_acct_grp
AS SELECT 
	src.sk_acct_grp AS acct_grp_id,
    NULL::bigint AS prnt_acct_grp_id,
    Upper(src.portfolio_name)::character varying(512) AS acct_grp_name,
    '1900-01-01'::date AS acct_grp_start_dt,
    '9999-12-31'::date AS acct_grp_end_dt,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT 
			c.sk_acct_grp,
			c.portfolio_name,
			max(c.info_system_id) AS info_system_id,
			max(c.input_file_id) AS input_file_id
		  FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033005_res_wroff c
		  WHERE c.sk_acct_grp > 0::bigint
		  GROUP BY c.sk_acct_grp, c.portfolio_name
		 ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033005_acct_rate.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033005_acct_rate 
AS 
SELECT distinct  
  src.sk_agrmnt as agrmnt_id  
, 1::int AS rate_type_id  
, 1::int AS bal_cat_type_id  
, src.record_date_from as acct_rate_start_dt  
, CASE WHEN 'A'::text = (SELECT upper(max(p.paramvalue)) AS max FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params p WHERE upper(p.paramname) = 'TYPE'::text) THEN '9999-12-31'::date
       WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date 
  ELSE src.record_date_to END AS acct_rate_end_dt  
, CASE WHEN src.reserv_loan_rate BETWEEN (-999.999999999999)::numeric(15,12) AND (999.999999999999)::numeric(15,12) OR src.reserv_loan_rate IS NULL THEN src.reserv_loan_rate 
  ELSE (-999.999999999999)::numeric(15,12)
  END::numeric(15,12) AS acct_rate  
, 6::INT AS acct_rate_time_period_id  
, (-1)::int AS intrst_calc_type_id  
, (-1)::int AS term_compliance_type_id   
, 'N'::character(1) AS deleted_flag  
, 'I'::character(1) AS action_cd  
, input_file_id  
, info_system_id 
FROM  ( 
   SELECT 
   c3005.sk_agrmnt 
   ,c3005.record_date_from 
   ,c3005.record_date_to 
   ,c3005.reserv_loan_rate 
   ,c3005.info_system_id 
   ,c3005.input_file_id 
   FROM s_grnplm_as_t_didsd_016_db_stg.C0160000033005_RES_WROFF c3005 
   WHERE sk_agrmnt IS NOT NULL 
) src;
"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033005_acct_stts_hist3.sql	"CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000033005_acct_stts_hist3
AS SELECT 
	src.sk_agrmnt AS agrmnt_id,
    (-1)::bigint AS acct_stts_type_id,
    src.record_date_from AS acct_stts_start_dt,
    src.record_date_to AS acct_stts_end_dt,
    src.acct_stts_reason_id,
    (-1002)::bigint AS acct_stts_role_id,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( 
		 SELECT 
			_src.sk_agrmnt,
            _src.record_date_from,
            COALESCE(_src.record_date_to, '9999-12-31'::date) AS record_date_to,
            _src.acct_stts_reason_id,
            ( SELECT max(k.tgt_id) AS max FROM s_grnplm_as_t_didsd_016_db_tmd.k_info_system k WHERE k.nk01_info_system_type_cd = '016'::text AND k.nk01_info_system_inst_cd = '000003'::text) AS info_system_id,
            _src.input_file_id
           FROM ( 
				 SELECT 
					_sk_agrmnt.tgt_id AS sk_agrmnt,
                    _s3005.record_date_from,
					lead(_s3005.record_date_from-1,1,'9999-12-31'::date) over (partition by _s3005.contract_idt order by _s3005.record_date_from) as record_date_to,
                    coalesce(_acc_reason_tp.acct_stts_reason_id, (-1)::bigint) as acct_stts_reason_id,
                    _s3005.input_file_id,
                    _s3005.contract_idt
                 FROM ( SELECT 
						_t.contract_idt,
						_t.record_date_from,
						_t.bad_debts_reason,
						max(_t.bad_debts_reason) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING) AS prev_bad_debts_reason,
						CASE
							WHEN _t.bad_debts_reason = (max(_t.bad_debts_reason) OVER (PARTITION BY _t.contract_idt ORDER BY _t.record_date_from ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) 
							THEN 1::int
							ELSE 0::int
						END AS is_eq,
						_t.input_file_id
                        FROM ( SELECT s3002.contract_idt,
                                    s3002.record_date_from,
                                    upper(s3002.bad_debts_reason) as bad_debts_reason,
                                    s3002.input_file_id
                                   FROM s_grnplm_as_t_didsd_016_db_stg.l016_3005_res_wroff s3002
                                  WHERE s3002.bad_debts_reason IS NOT NULL
							 ) _t
					   ) _s3005
                  JOIN s_grnplm_as_t_didsd_016_db_tmd.k_agrmnt_nk76 _sk_agrmnt 
				    ON _sk_agrmnt.info_system_inst_cd = '000003'::text 
					AND _sk_agrmnt.info_system_type_cd = '016'::text 
					AND _sk_agrmnt.nk76_agreement_id_f9 IS NOT NULL 
					AND _sk_agrmnt.nk76_agreement_id_f9 = _s3005.contract_idt
                  LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.t_acct_stts_reason_type _acc_reason_tp ON upper(_acc_reason_tp.acct_stts_reason_cd) = upper(_s3005.bad_debts_reason)
                  WHERE 1 = 1 
				  AND _s3005.is_eq = 0::int
				  AND _sk_agrmnt.tgt_id IS NOT NULL
				  ) _src
		  ) src
  GROUP BY src.sk_agrmnt, (-1)::integer, src.record_date_from, src.record_date_to, src.acct_stts_reason_id, (-1002)::integer, 'N'::character(1), 'I'::character(1), src.input_file_id, src.info_system_id;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033005_agmt_cls_asc.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033005_agmt_cls_asc
AS 
SELECT distinct
	src.sk_agrmnt AS agrmnt_id,
	5::int AS agrmnt_clsfctn_id,
	src.record_date_from AS agrmnt_class_start_dt,
	CASE WHEN 'A'::text = (SELECT upper(max(p.paramvalue)) AS max FROM s_grnplm_as_t_didsd_016_db_stg.b0160000039999_params p WHERE upper(p.paramname) = 'TYPE'::text) THEN '9999-12-31'::date
		 WHEN src.record_date_to >= '2100-01-01'::date THEN '9999-12-31'::date
	ELSE src.record_date_to
	END AS agrmnt_class_end_dt,
	COALESCE(src.sk_agrmnt_cls_val, (-1)::bigint) AS agrmnt_class_val_id,
	'N'::character(1) AS deleted_flag,
	'I'::character(1) AS action_cd,
	src.input_file_id,
	src.info_system_id
FROM ( SELECT c3005.sk_agrmnt,
		c3005.record_date_from,
		c3005.record_date_to,
		c3005.sk_agrmnt_cls_val,
		c3005.info_system_id,
		c3005.input_file_id
	   FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033005_res_wroff c3005
	   WHERE c3005.sk_agrmnt IS NOT NULL
	  ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033005_agmt_cls_val.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033005_agmt_cls_val
AS SELECT 
	src.sk_agrmnt_cls_val AS agrmnt_class_val_id,
    5::int AS agrmnt_clsfctn_id,
    src.beh_type_category::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::int AS prnt_agmt_class_val_id,
    NULL::int AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT
			c.sk_agrmnt_cls_val,
            c.beh_type_category,
            c.info_system_id,
            min(c.input_file_id) AS input_file_id
          FROM s_grnplm_as_t_didsd_016_db_stg.c0160000033005_res_wroff c
          WHERE c.sk_agrmnt_cls_val IS NOT NULL
		  group by c.sk_agrmnt_cls_val, c.beh_type_category, c.info_system_id
		 ) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033005_pty_class_ass.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033005_pty_class_ass
AS
SELECT
  PTY_ID AS pty_id
 ,pty_clsfctn_id as pty_clsfctn_id
 ,RECORD_DATE_FROM AS pty_class_start_dt
 ,pty_class_val_id AS pty_class_val_id
 ,RECORD_DATE_TO AS pty_class_end_dt
 ,'N'::character(1) AS deleted_flag
 ,'I'::character(1) AS action_cd
 ,input_file_id
 ,info_system_id
FROM 
  (select
   coalesce(_SK_PTY.TGT_ID, case when _s3005.f_depr is null then (-1)::bigint else (-999)::bigint end) AS PTY_ID,
   _s3005.CONTRACT_IDT,
   TCL.PTY_CLSFCTN_ID,
   TCL.PTY_CLASS_VAL_ID,
   _s3005.RECORD_DATE_FROM,
   lead(_s3005.record_date_from-1,1,'9999-12-31'::date) over (partition by _s3005.contract_idt order by _s3005.record_date_from) as record_date_to,
   _s3005.INPUT_FILE_ID,
   (select max(k.tgt_id) from s_grnplm_as_t_didsd_016_db_tmd.k_info_system k where k.nk01_info_system_type_cd = '016'::text and k.nk01_info_system_inst_cd = '000003'::text) as info_system_id
   from  
	   (SELECT 
		   CONTRACT_IDT
	   ,   RECORD_DATE_FROM
	   ,   F_DEPR
	   ,   Max(F_DEPR) Over (PARTITION BY CONTRACT_IDT ORDER BY RECORD_DATE_FROM ROWS BETWEEN 1 Preceding AND 1 Preceding) AS PREV_F_DEPR
	   ,   CASE WHEN F_DEPR = Max(F_DEPR) Over (PARTITION BY CONTRACT_IDT ORDER BY RECORD_DATE_FROM ROWS BETWEEN 1 Preceding AND 1 Preceding) THEN 1::int ELSE 0::int END AS is_eq
	   ,   INPUT_FILE_ID                 
	   FROM (
			SELECT distinct
			  w.CONTRACT_IDT                  
			, w.RECORD_DATE_FROM                
			, w.F_DEPR
			, w.INPUT_FILE_ID
			FROM s_grnplm_as_t_didsd_016_db_stg.L016_3005_RES_WROFF w
			JOIN s_grnplm_as_t_didsd_016_db_stg.C0160000033005_RES_WROFF c on w.contract_idt=c.contract_idt
			where w.F_DEPR is not null
			) _t
	   ) _s3005
JOIN s_grnplm_as_t_didsd_016_db_stg.L016_3001_ATTR a on a.contract_idt=_s3005.contract_idt and a.RECORD_DATE_TO= '9999-12-31'::date
LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.K_PTY_NK229 as _SK_PTY
  ON _SK_PTY.INFO_SYSTEM_INST_CD = '000003'::text
  AND _SK_PTY.INFO_SYSTEM_TYPE_CD='016'::text
  AND _SK_PTY.NK229_CLIENT_ID IS NOT NULL
  AND _SK_PTY.NK229_CLIENT_ID = a.CLIENT_IDT
LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.t_pty_class_val tcl
  on tcl.pty_class_val_cd = _s3005.f_depr
  AND tcl.pty_clsfctn_id=(-1038)::bigint --Фактор обесценивания
where is_eq=0::int
) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n0160000033005_pty_class_ass2.sql	"create or replace view s_grnplm_as_t_didsd_016_db_stg.n0160000033005_pty_class_ass2
AS
SELECT
  PTY_ID AS pty_id
 ,pty_clsfctn_id AS pty_clsfctn_id
 ,RECORD_DATE_FROM AS pty_class_start_dt
 ,pty_class_val_id AS pty_class_val_id
 ,RECORD_DATE_TO AS pty_class_end_dt
 ,'N'::character(1) AS deleted_flag
 ,'I'::character(1) AS action_cd
 ,input_file_id
 ,info_system_id
FROM 
  (select
   coalesce(_SK_PTY.TGT_ID, case when _s3005.fin_pos_curr is null then (-1)::bigint else (-999)::bigint end) AS PTY_ID,
   _s3005.CONTRACT_IDT,
   TCL.PTY_CLSFCTN_ID,
   TCL.PTY_CLASS_VAL_ID,
   _s3005.RECORD_DATE_FROM,
   lead(_s3005.RECORD_DATE_FROM-1,1,'9999-12-31'::date) over (partition by _s3005.CONTRACT_IDT order by _s3005.RECORD_DATE_FROM) as RECORD_DATE_TO,
   _s3005.INPUT_FILE_ID,
   (select max(k.tgt_id) from s_grnplm_as_t_didsd_016_db_tmd.k_info_system k where k.nk01_info_system_type_cd = '016'::text and k.nk01_info_system_inst_cd = '000003'::text) as INFO_SYSTEM_ID
    from  
	   (SELECT 
		   CONTRACT_IDT
	   ,   RECORD_DATE_FROM
	   ,   FIN_POS_CURR
	   ,   Max(FIN_POS_CURR) Over (PARTITION BY CONTRACT_IDT ORDER BY RECORD_DATE_FROM ROWS BETWEEN 1 Preceding AND 1 Preceding) AS PREV_FIN_POS_CURR
	   ,   CASE WHEN FIN_POS_CURR = Max(FIN_POS_CURR) Over (PARTITION BY CONTRACT_IDT ORDER BY RECORD_DATE_FROM ROWS BETWEEN 1 Preceding AND 1 Preceding) THEN 1::int ELSE 0::int END AS is_eq
	   ,   INPUT_FILE_ID                 
	   FROM (
			SELECT 
			  w.CONTRACT_IDT                  
			, w.RECORD_DATE_FROM                
			, w.FIN_POS_CURR
			, w.INPUT_FILE_ID
			FROM s_grnplm_as_t_didsd_016_db_stg.L016_3005_RES_WROFF w
			JOIN s_grnplm_as_t_didsd_016_db_stg.C0160000033005_RES_WROFF c on w.contract_idt=c.contract_idt
			where w.FIN_POS_CURR is not null 
			) _t  
	   ) _s3005
JOIN s_grnplm_as_t_didsd_016_db_stg.L016_3001_ATTR a on a.contract_idt=_s3005.contract_idt and a.RECORD_DATE_TO='9999-12-31'::date
LEFT JOIN s_grnplm_as_t_didsd_016_db_tmd.K_PTY_NK229 as _SK_PTY
  ON _SK_PTY.INFO_SYSTEM_INST_CD = '000003'::text
  AND _SK_PTY.INFO_SYSTEM_TYPE_CD='016'::text
  AND _SK_PTY.NK229_CLIENT_ID IS NOT NULL
  AND _SK_PTY.NK229_CLIENT_ID = a.CLIENT_IDT
LEFT JOIN s_grnplm_as_t_didsd_016_db_stg.t_pty_class_val tcl
  on tcl.pty_class_val_cd = _s3005.fin_pos_curr
  AND tcl.pty_clsfctn_id=5::int --Текущее финансовое положение
where is_eq=0::int
) src;"
v.s_grnplm_as_t_didsd_016_db_stg.n016000004.sql	"-- s_grnplm_as_t_didsd_016_db_stg.n0160000044003_agmt_cls_val source

CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000044003_agmt_cls_val
AS SELECT src.sk_agrmnt_cls_val_flg AS agrmnt_class_val_id,
    (-1042)::smallint AS agrmnt_clsfctn_id,
    src.stage_3_flag::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
        CASE
            WHEN src.stage_3_flag = 1::numeric THEN '3 этап (корзина)'::text
            ELSE src.stage_3_flag::text
        END::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c.sk_agrmnt_cls_val_flg,
            c.stage_3_flag,
            c.record_source,
            c.info_system_id,
            min(c.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000044003_ifrs_reserve c
          WHERE c.sk_agrmnt_cls_val_flg > 0
          GROUP BY c.sk_agrmnt_cls_val_flg, c.stage_3_flag, c.record_source, c.info_system_id) src;


-- s_grnplm_as_t_didsd_016_db_stg.n0160000044003_src_system_type source

CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000044003_src_system_type
AS SELECT src.sk_src_sys_type::bigint AS src_system_type_id,
    src.record_source::character varying(128) AS src_system_type_cd,
    src.record_source::character varying(256) AS src_system_type_name,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c.sk_src_sys_type,
            c.record_source,
            c.info_system_id,
            min(c.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000044003_ifrs_reserve c
          WHERE c.sk_src_sys_type > 0
          GROUP BY c.sk_src_sys_type, c.record_source, c.info_system_id) src;


-- s_grnplm_as_t_didsd_016_db_stg.n0160000044004_acct_grp source

CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000044004_acct_grp
AS SELECT src.sk_acct_grp AS acct_grp_id,
    NULL::bigint AS prnt_acct_grp_id,
    src.portfolio_name::character varying(512) AS acct_grp_name,
    '1900-01-01'::date AS acct_grp_start_dt,
    '9999-12-31'::date AS acct_grp_end_dt,
    src.reserve_other_rate::numeric(18,4) AS acct_grp_reserv_rate,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c.sk_acct_grp,
            c.portfolio_name,
            c.reserve_other_rate,
            c.info_system_id,
            c.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000044004_f9_overwr_portf c
          WHERE c.sk_acct_grp > 0
          GROUP BY c.sk_acct_grp, c.portfolio_name, c.reserve_other_rate, c.info_system_id, c.input_file_id) src;


-- s_grnplm_as_t_didsd_016_db_stg.n0160000044004_acct_st_rsn_tp source

CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000044004_acct_st_rsn_tp
AS SELECT src.sk_acct_stts_reason_type AS acct_stts_reason_id,
    NULL::character varying(64) AS acct_stts_reason_cd,
    src.reason::character varying(512) AS acct_stts_reason_desc,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c.sk_acct_stts_reason_type,
            c.reason,
            c.reserve_other_rate,
            c.info_system_id,
            c.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000044004_f9_overwr_portf c
          WHERE c.sk_acct_stts_reason_type > 0
          GROUP BY c.sk_acct_stts_reason_type, c.reason, c.reserve_other_rate, c.info_system_id, c.input_file_id) src;


-- s_grnplm_as_t_didsd_016_db_stg.n0160000044004_agmt_cls_val source

CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000044004_agmt_cls_val
AS SELECT src.sk_agrmnt_cls_val AS agrmnt_class_val_id,
    5::smallint AS agrmnt_clsfctn_id,
    src.beh_type_category::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c.sk_agrmnt_cls_val,
            c.beh_type_category,
            c.info_system_id,
            min(c.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000044004_f9_overwr_portf c
          WHERE c.sk_agrmnt_cls_val > 0
          GROUP BY c.sk_agrmnt_cls_val, c.beh_type_category, c.info_system_id) src;


-- s_grnplm_as_t_didsd_016_db_stg.n0160000044005_acct_grp source

CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000044005_acct_grp
AS SELECT src.sk_acct_grp AS acct_grp_id,
    NULL::bigint AS prnt_acct_grp_id,
    src.portfolio_name::character varying(512) AS acct_grp_name,
    '1900-01-01'::date AS acct_grp_start_dt,
    '9999-12-31'::date AS acct_grp_end_dt,
    src.reserve_other_rate::numeric(18,4) AS acct_grp_reserv_rate,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c.sk_acct_grp,
            c.portfolio_name,
            c.reserve_other_rate,
            c.info_system_id,
            c.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000044005_f9_overwr_portf c
          WHERE c.sk_acct_grp > 0
          GROUP BY c.sk_acct_grp, c.portfolio_name, c.reserve_other_rate, c.info_system_id, c.input_file_id) src;


-- s_grnplm_as_t_didsd_016_db_stg.n0160000044005_acct_st_rsn_tp source

CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000044005_acct_st_rsn_tp
AS SELECT src.sk_acct_stts_reason_type AS acct_stts_reason_id,
    NULL::character varying(64) AS acct_stts_reason_cd,
    src.reason::character varying(512) AS acct_stts_reason_desc,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c.sk_acct_stts_reason_type,
            c.reason,
            c.reserve_other_rate,
            c.info_system_id,
            c.input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000044005_f9_overwr_portf c
          WHERE c.sk_acct_stts_reason_type > 0
          GROUP BY c.sk_acct_stts_reason_type, c.reason, c.reserve_other_rate, c.info_system_id, c.input_file_id) src;


-- s_grnplm_as_t_didsd_016_db_stg.n0160000044005_agmt_cls_val source

CREATE OR REPLACE VIEW s_grnplm_as_t_didsd_016_db_stg.n0160000044005_agmt_cls_val
AS SELECT src.sk_agrmnt_cls_val AS agrmnt_class_val_id,
    5::smallint AS agrmnt_clsfctn_id,
    src.beh_type_category::character varying(300) AS agrmnt_clsfctn_val_cd,
    NULL::smallint AS prnt_agmt_class_val_id,
    NULL::smallint AS prnt_agrmnt_clsfctn_id,
    NULL::character varying(512) AS agrmnt_class_val_desc,
    '1900-01-01'::date AS agmt_class_val_start_dt,
    '9999-12-31'::date AS agmt_class_val_end_dt,
    'N'::character(1) AS deleted_flag,
    'I'::character(1) AS action_cd,
    src.input_file_id,
    src.info_system_id
   FROM ( SELECT c.sk_agrmnt_cls_val,
            c.beh_type_category,
            c.info_system_id,
            min(c.input_file_id) AS input_file_id
           FROM s_grnplm_as_t_didsd_016_db_stg.c0160000044005_f9_overwr_portf c
          WHERE c.sk_agrmnt_cls_val > 0
          GROUP BY c.sk_agrmnt_cls_val, c.beh_type_category, c.info_system_id) src;"
